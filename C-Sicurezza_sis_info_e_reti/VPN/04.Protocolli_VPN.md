# 4. Protocolli VPN

I protocolli VPN definiscono le regole e i metodi per stabilire, mantenere e proteggere le connessioni VPN. Ogni protocollo ha caratteristiche specifiche che lo rendono più adatto a determinati scenari d'uso.

## 4.1 IPsec (Internet Protocol Security)

**IPsec** è una suite di protocolli per la sicurezza delle comunicazioni IP, progettata per garantire autenticazione, integrità e confidenzialità a livello network layer.

### Componenti principali

IPsec non è un singolo protocollo ma una suite completa:

```
┌──────────────────────────────────────┐
│         IPsec Suite                  │
├──────────────────────────────────────┤
│  IKE (Internet Key Exchange)         │ ← Negoziazione e gestione chiavi
│  - IKEv1 / IKEv2                     │
├──────────────────────────────────────┤
│  AH (Authentication Header)          │ ← Autenticazione e integrità
├──────────────────────────────────────┤
│  ESP (Encapsulating Security Payload)│ ← Crittografia e autenticazione
└──────────────────────────────────────┘
```

### AH (Authentication Header)

Fornisce **autenticazione** e **integrità** dei pacchetti IP, ma **NON la confidenzialità** (non cripta).

#### Struttura AH
```
┌─────────────────────────────────────────────────┐
│ Next Header | Payload Len | Reserved            │
├─────────────────────────────────────────────────┤
│ Security Parameters Index (SPI)                 │
├─────────────────────────────────────────────────┤
│ Sequence Number                                 │
├─────────────────────────────────────────────────┤
│ Authentication Data (ICV)                       │
│ (Hash del pacchetto)                            │
└─────────────────────────────────────────────────┘
```

#### Caratteristiche AH
- **Protegge**: Header IP, payload, ma NON cripta
- **HMAC**: calcola hash dell'intero pacchetto
- **Anti-replay**: sequence number previene attacchi replay
- **Incompatibile con NAT**: l'hash include l'IP che verrebbe modificato da NAT

**Quando usare AH**: Raramente oggi. Utilizzato solo quando serve autenticazione senza crittografia (es. per performance). ESP lo ha sostituito nella maggior parte degli scenari.

### ESP (Encapsulating Security Payload)

Fornisce **crittografia**, **autenticazione** e **integrità**. È il protocollo IPsec più utilizzato.

#### Struttura ESP
```
┌────────────────────────────────────────┐
│ Security Parameters Index (SPI)        │ ← Identifica SA
├────────────────────────────────────────┤
│ Sequence Number                        │ ← Anti-replay
├────────────────────────────────────────┤
│ Payload Data (variabile)               │
│ ┌────────────────────────────────────┐ │
│ │   DATI CRITTOGRAFATI               │ │
│ │   - IP header originale (tunnel)   │ │
│ │   - TCP/UDP header                 │ │
│ │   - Application data               │ │
│ └────────────────────────────────────┘ │
├────────────────────────────────────────┤
│ Padding (0-255 byte)                   │
├────────────────────────────────────────┤
│ Pad Length | Next Header               │
├────────────────────────────────────────┤
│ Authentication Data (opzionale)        │ ← HMAC per integrità
└────────────────────────────────────────┘
```

#### Caratteristiche ESP
- **Crittografia**: AES, 3DES, ChaCha20
- **Autenticazione**: HMAC-SHA256, HMAC-SHA512
- **Modalità**: Transport o Tunnel
- **Compatibile con NAT-T**: quando incapsulato in UDP

**ESP è la scelta standard** per VPN moderne.

### IKE (Internet Key Exchange)

**IKE** è il protocollo per negoziare e stabilire le **Security Associations (SA)** necessarie per AH/ESP.

#### Fasi IKE

**IKEv1 - Due fasi separate:**

```
Fase 1: IKE SA (ISAKMP SA)
┌─────────────────────────────────────┐
│ 1. Negoziazione algoritmi           │
│    - Encryption: AES-256            │
│    - Hash: SHA-256                  │
│    - DH Group: Group 14             │
│ 2. Autenticazione mutua             │
│    - Pre-shared key o certificati   │
│ 3. Derivazione chiavi               │
│    - Diffie-Hellman key exchange    │
└─────────────────────────────────────┘
         ↓
Canale sicuro stabilito (IKE SA)
         ↓
Fase 2: IPsec SA
┌─────────────────────────────────────┐
│ 1. Negoziazione parametri IPsec     │
│    - Protocollo: ESP                │
│    - Encryption: AES-128-GCM        │
│    - Lifetime: 3600 sec             │
│ 2. Scambio chiavi IPsec             │
│ 3. Creazione IPsec SA               │
└─────────────────────────────────────┘
         ↓
Tunnel IPsec attivo
```

**IKEv2 - Processo semplificato:**

```
┌────────────────────────────────────────────┐
│ IKE_SA_INIT                                │
│ - Negoziazione algoritmi crittografici     │
│ - Diffie-Hellman exchange                  │
│ - Scambio nonce                            │
└────────────────────────────────────────────┘
              ↓
┌────────────────────────────────────────────┐
│ IKE_AUTH                                   │
│ - Autenticazione peer                      │
│ - Creazione primo CHILD_SA                 │
│ - Configurazione traffico                  │
└────────────────────────────────────────────┘
              ↓
         Tunnel attivo
```

#### IKEv2 vs IKEv1

| Feature | IKEv1 | IKEv2 |
|---------|-------|-------|
| **Messaggi iniziali** | 9+ messaggi | 4 messaggi |
| **Autenticazione** | Complessa | Semplificata |
| **NAT-T** | Extension | Nativo |
| **MOBIKE** | No | Sì (mobility) |
| **Affidabilità** | No retransmission | Built-in |
| **Dead Peer Detection** | Separate | Integrato |
| **Configurazione** | Complessa | Più semplice |
| **RFC** | RFC 2409 | RFC 7296 |

**IKEv2 è raccomandato** per nuove implementazioni.

### Modalità IPsec

#### Transport Mode

```
PRIMA:
[IP Header][TCP/UDP Header][Data]

DOPO (ESP Transport):
[IP Header][ESP Header][TCP/UDP Header][Data][ESP Trailer][ESP Auth]
            └────────── Crittografato ──────────┘
```

**Caratteristiche:**
- IP header originale rimane visibile
- Solo payload crittografato
- Meno overhead
- Usato in host-to-host
- Problematico con NAT

**Quando usare:**
- Comunicazione diretta tra due host
- L2TP/IPsec (L2TP over IPsec transport)
- Ottimizzazione performance quando possibile

#### Tunnel Mode

```
PRIMA:
[IP Header A][TCP][Data]

DOPO (ESP Tunnel):
[Nuovo IP Header][ESP Header][IP Header A][TCP][Data][ESP Trailer][ESP Auth]
                             └───────── Crittografato ─────────┘
```

**Caratteristiche:**
- Intero pacchetto IP originale crittografato
- Nuovo header IP per routing
- Maggiore overhead ma più sicuro
- Standard per VPN gateway
- Source/destination IP nascosti

**Quando usare:**
- VPN site-to-site
- VPN remote access
- Quando serve nascondere routing interno

### Security Association (SA)

Una **SA** definisce tutti i parametri per una connessione IPsec sicura:

```
SA Database (SAD):
┌─────────────────────────────────────┐
│ SPI: 0x12345678                     │ ← Identificatore univoco
│ Destination IP: 203.0.113.10        │
│ Protocol: ESP                       │
│ Encryption: AES-256-CBC             │
│ Authentication: HMAC-SHA256         │
│ Encryption Key: [binary data]       │
│ Authentication Key: [binary data]   │
│ Lifetime: 3600 seconds              │
│ Sequence Number: 42                 │
└─────────────────────────────────────┘
```

**Concetti chiave:**
- SA sono **unidirezionali**: serve una SA per ogni direzione
- **SPI** (Security Parameter Index): identifica univocamente la SA
- **Lifetime**: SA expire e vengono rinegoziati automaticamente
- **SPD** (Security Policy Database): definisce quale traffico protegge

### Configurazione IPsec pratica

#### strongSwan (Linux) - Site-to-Site

**/etc/ipsec.conf**
```bash
config setup
    charondebug="ike 2, knl 2, cfg 2"

conn site-to-site
    left=%any
    leftid=@site-a.example.com
    leftsubnet=192.168.1.0/24
    right=203.0.113.10
    rightid=@site-b.example.com
    rightsubnet=192.168.2.0/24
    
    # IKEv2
    keyexchange=ikev2
    
    # Fase 1 (IKE SA)
    ike=aes256-sha256-modp2048!
    ikelifetime=24h
    
    # Fase 2 (IPsec SA)
    esp=aes256-sha256!
    lifetime=8h
    
    # Autenticazione
    authby=secret
    
    # Modalità
    type=tunnel
    
    # Auto-start
    auto=start
    
    # Dead Peer Detection
    dpdaction=restart
    dpddelay=30s
```

**/etc/ipsec.secrets**
```
@site-a.example.com @site-b.example.com : PSK "MyVerySecurePreSharedKey123!"
```

#### Cisco IOS Router

```cisco
! Fase 1 - ISAKMP Policy
crypto isakmp policy 10
 encryption aes 256
 hash sha256
 authentication pre-share
 group 14
 lifetime 86400

crypto isakmp key MySecretKey address 203.0.113.10

! Fase 2 - Transform Set
crypto ipsec transform-set ESP-AES256-SHA256 esp-aes 256 esp-sha256-hmac

! Crypto Map
crypto map SITE-TO-SITE 10 ipsec-isakmp
 set peer 203.0.113.10
 set transform-set ESP-AES256-SHA256
 match address VPN-TRAFFIC
 set pfs group14

! Traffic interessante
ip access-list extended VPN-TRAFFIC
 permit ip 192.168.1.0 0.0.0.255 192.168.2.0 0.0.0.255

! Applicazione interfaccia
interface GigabitEthernet0/0
 description Internet Interface
 ip address 198.51.100.5 255.255.255.252
 crypto map SITE-TO-SITE
```

### Troubleshooting IPsec

**Comandi diagnostici Linux (strongSwan)**
```bash
# Stato connessioni
ipsec status
ipsec statusall

# Restart daemon
ipsec restart

# Test configurazione
ipsec verify

# Logging live
ipsec up site-to-site --debug-all

# Packet capture
tcpdump -i eth0 esp or udp port 500 or udp port 4500
```

**Cisco IOS**
```cisco
! Stato ISAKMP (Fase 1)
show crypto isakmp sa

! Stato IPsec (Fase 2)
show crypto ipsec sa

! Statistiche
show crypto engine connections active

! Debug (attivare con cautela)
debug crypto isakmp
debug crypto ipsec
```

### Problemi comuni

1. **Mismatch algoritmi**
   - Verificare compatibilità encryption/hash/DH group
   - Controllare IKE/ESP proposals

2. **Autenticazione fallita**
   - PSK errata o non corrispondente
   - Certificati scaduti o non trusted
   - IDs non corrispondenti

3. **Traffico non passa**
   - SA stabilita ma traffico interessante non definito
   - Firewall blocca ESP (IP proto 50) o UDP 500/4500
   - Routing errato dopo tunnel up

4. **NAT traversal issues**
   - NAT-T non abilitato
   - Keep-alive non configurato
   - Timeout NAT mapping

### Best Practices IPsec

✅ **Usa IKEv2** invece di IKEv1 per nuove implementazioni  
✅ **AES-256-GCM** per encryption (AEAD mode)  
✅ **SHA-256 o superiore** per hashing  
✅ **DH Group 14** (2048-bit) minimo, preferire Group 19-21 (ECC)  
✅ **Perfect Forward Secrecy (PFS)** sempre abilitato  
✅ **Certificati** invece di PSK per grandi deployment  
✅ **Dead Peer Detection** per reliability  
✅ **Lifetime ragionevoli**: IKE 24h, IPsec 8h  

❌ **Evita DES/3DES**: troppo lenti e vulnerabili  
❌ **Evita MD5/SHA-1**: considerati insicuri  
❌ **Evita DH Group < 14**: vulnerabili a attacchi  
❌ **Non usare PSK deboli**: minimo 20 caratteri casuali

---

## 4.2 SSL/TLS VPN

Le **SSL/TLS VPN** utilizzano il protocollo di crittografia SSL (Secure Sockets Layer) o il suo successore TLS (Transport Layer Security) per creare tunnel VPN sicuri a livello applicativo.

### Architettura SSL/TLS VPN

```
┌────────────────────────────────────────┐
│  Application Layer (Layer 7)           │ ← HTTP, SSH, RDP
├────────────────────────────────────────┤
│  SSL/TLS Layer                         │ ← Crittografia
├────────────────────────────────────────┤
│  Transport Layer (Layer 4)             │ ← TCP
├────────────────────────────────────────┤
│  Network Layer (Layer 3)               │ ← IP
└────────────────────────────────────────┘
```

### Handshake SSL/TLS

```
Client                                Server
  │                                     │
  ├─── ClientHello ───────────────────→ │  (1) Versione TLS, cipher suites
  │                                     │
  │  ←─────── ServerHello ──────────────┤  (2) Cipher selezionata
  │  ←─────── Certificate ──────────────┤  (3) Certificato server
  │  ←─── ServerKeyExchange ────────────┤  (4) Parametri DH (opzionale)
  │  ←───── ServerHelloDone ────────────┤  (5) Fine messaggi server
  │                                     │
  ├── ClientKeyExchange ───────────────→│  (6) Pre-master secret (crittografato)
  ├─── ChangeCipherSpec ───────────────→│  (7) Attiva crittografia
  ├────── Finished ────────────────────→│  (8) Verifica handshake
  │                                     │
  │  ←──── ChangeCipherSpec ────────────┤  (9) Server attiva crittografia
  │  ←─────── Finished ─────────────────┤  (10) Conferma
  │                                     │
  ├══════ Tunnel TLS Stabilito ═════════┤
  │                                     │
  ├─ Application Data (crittografata) ─→│
  │ ←─ Application Data (crittografata)─┤
```

### Cipher Suites

Una **cipher suite** definisce gli algoritmi utilizzati:

```
TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
 │    │    │         │      │    │
 │    │    │         │      │    └── Hash: SHA-384
 │    │    │         │      └─────── Autenticazione: GCM
 │    │    │         └────────────── Encryption: AES-256
 │    │    └──────────────────────── Autenticazione: RSA
 │    └───────────────────────────── Key exchange: ECDHE
 └────────────────────────────────── Protocollo: TLS
```

**Cipher suites moderne raccomandate:**
- `TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384`
- `TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256`
- `TLS_AES_256_GCM_SHA384` (TLS 1.3)

**Da evitare:**
- Qualsiasi cosa con `RC4`, `MD5`, `DES`, `3DES`
- Cipher suites senza Forward Secrecy (no DHE/ECDHE)
- CBC mode in TLS 1.0/1.1 (vulnerabile a BEAST, Lucky13)

### Versioni TLS

| Versione | Anno | Stato | Note |
|----------|------|-------|------|
| SSL 2.0 | 1995 | ❌ Deprecato | Vulnerabilità critiche |
| SSL 3.0 | 1996 | ❌ Deprecato | Vulnerabile a POODLE |
| TLS 1.0 | 1999 | ⚠️ Deprecato 2020 | Vulnerabilità note |
| TLS 1.1 | 2006 | ⚠️ Deprecato 2020 | Superato |
| **TLS 1.2** | 2008 | ✅ **Attuale** | Standard current |
| **TLS 1.3** | 2018 | ✅ **Raccomandato** | Più veloce e sicuro |

**TLS 1.3 vantaggi:**
- Handshake più veloce (1-RTT, 0-RTT possibile)
- Cipher suites semplificate e più sicure
- Forward secrecy obbligatorio
- Rimozione algoritmi obsoleti

---

### OpenVPN

**OpenVPN** è l'implementazione SSL/TLS VPN open-source più popolare e affidabile.

#### Caratteristiche

- **Protocollo**: Custom su SSL/TLS
- **Porte**: Configurabile, di default UDP 1194 o TCP 443
- **Cifratura**: Libreria OpenSSL (AES, ChaCha20)
- **Autenticazione**: Certificati X.509, username/password, MFA
- **Piattaforme**: Linux, Windows, macOS, iOS, Android, router

#### Modalità operative

**1. Routed (TUN device)**
```
Virtual Network Interface: tun0
Traffico IP instradato attraverso il tunnel
Layer 3 (IP)
```
- Più comune ed efficiente
- Routing a livello IP
- Supporta subnet diverse

**2. Bridged (TAP device)**
```
Virtual Ethernet Interface: tap0
Traffico Ethernet bridged
Layer 2 (Ethernet)
```
- Trasporta frame Ethernet
- Client nella stessa subnet della LAN
- Supporta protocolli non-IP (es. IPX, NetBEUI - raro oggi)

#### Configurazione OpenVPN Server

**/etc/openvpn/server.conf**
```bash
# Porta e protocollo
port 1194
proto udp
# proto tcp # alternative per firewall restrittivi

# Device virtuale
dev tun

# Certificati e chiavi
ca /etc/openvpn/ca.crt
cert /etc/openvpn/server.crt
key /etc/openvpn/server.key
dh /etc/openvpn/dh2048.pem

# Subnet VPN (pool client)
server 10.8.0.0 255.255.255.0

# Mantieni connessioni attraverso riavvii
persist-key
persist-tun

# Route da pushare ai client
push "route 192.168.1.0 255.255.255.0"  # LAN aziendale
push "route 192.168.2.0 255.255.255.0"  # Altra subnet

# DNS per i client
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"

# Redirect-gateway (tutto il traffico via VPN)
# push "redirect-gateway def1"

# Keepalive
keepalive 10 120

# Crittografia
cipher AES-256-GCM
auth SHA256
tls-version-min 1.2

# Compressione (opzionale, può aiutare performance)
comp-lzo

# Privilegi ridotti (sicurezza)
user nobody
group nogroup

# Logging
status /var/log/openvpn/status.log
log-append /var/log/openvpn/openvpn.log
verb 3
```

#### Configurazione OpenVPN Client

**client.ovpn**
```bash
client
dev tun
proto udp

# Server VPN
remote vpn.company.com 1194

# Riprova connessione all'infinito
resolv-retry infinite

# Non bind su porta locale specifica
nobind

# Persist
persist-key
persist-tun

# Certificati
ca ca.crt
cert client.crt
key client.key

# Verifica certificato server
remote-cert-tls server

# Crittografia (deve matchare server)
cipher AES-256-GCM
auth SHA256

# Compressione
comp-lzo

# Logging
verb 3
```

#### Setup PKI per OpenVPN

**1. Installare Easy-RSA**
```bash
wget https://github.com/OpenVPN/easy-rsa/releases/latest/download/EasyRSA-3.x.x.tgz
tar xzf EasyRSA-3.x.x.tgz
cd EasyRSA-3.x.x
```

**2. Inizializzare PKI**
```bash
./easyrsa init-pki
```

**3. Creare CA**
```bash
./easyrsa build-ca
# Inserire passphrase per proteggere CA private key
```

**4. Generare certificato e chiave server**
```bash
./easyrsa gen-req server nopass
./easyrsa sign-req server server
```

**5. Generare parametri Diffie-Hellman**
```bash
./easyrsa gen-dh
```

**6. Generare certificati client**
```bash
./easyrsa gen-req client1 nopass
./easyrsa sign-req client client1
```

**7. Generare TLS auth key (opzionale, extra security)**
```bash
openvpn --genkey --secret ta.key
```

#### Configurazione con tls-auth/tls-crypt

Per maggiore sicurezza contro attacchi DoS e port scanning:

**Server:**
```bash
tls-crypt ta.key  # O tls-auth ta.key 0
```

**Client:**
```bash
tls-crypt ta.key  # O tls-auth ta.key 1
```

`tls-crypt` (raccomandato) critta l'intero handshake TLS, rendendo impossibile identificare che si tratta di OpenVPN.

#### Script di automazione

**server-up.sh** (eseguito quando server si avvia)
```bash
#!/bin/bash
# Abilita IP forwarding
echo 1 > /proc/sys/net/ipv4/ip_forward

# NAT per traffico VPN verso Internet
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE

# Permetti traffico VPN
iptables -A FORWARD -i tun0 -j ACCEPT
iptables -A FORWARD -o tun0 -j ACCEPT
```

**client-connect.sh** (eseguito per ogni client che si connette)
```bash
#!/bin/bash
# Logging personalizzato
echo "$(date): $common_name connected from $trusted_ip" >> /var/log/openvpn/connections.log
```

Configurare in server.conf:
```bash
script-security 2
up /etc/openvpn/server-up.sh
client-connect /etc/openvpn/client-connect.sh
```

#### Performance tuning

```bash
# Aumenta buffer send/receive
sndbuf 393216
rcvbuf 393216
push "sndbuf 393216"
push "rcvbuf 393216"

# Disabilita compressione se CPU è limitata
# comp-lzo no

# Fragment e mssfix per MTU optimization
fragment 1400
mssfix 1400
```

### Caratteristiche e vantaggi

✅ **Cross-platform**: supporto universale  
✅ **Firewall-friendly**: usa TCP 443 facilmente  
✅ **Flessibile**: altamente configurabile  
✅ **Open source**: codice audit able, gratuito  
✅ **Maturo e stabile**: in uso da 20+ anni  
✅ **Community**: ampia documentazione e supporto

### Limitazioni

❌ **Performance**: leggermente inferiore a IPsec/WireGuard  
❌ **Overhead**: maggiore di protocolli layer 3  
❌ **Complessità**: PKI richiede gestione certificati  
❌ **UDP può essere bloccato**: in reti molto restrittive

---

**Capitolo precedente**: [03. Tipologie di VPN](03.Tipologie_di_VPN.md)  
**Prossimo capitolo**: [05. Sicurezza nelle VPN](05.Sicurezza_nelle_VPN.md)

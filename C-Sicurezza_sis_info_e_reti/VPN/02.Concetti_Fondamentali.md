# 2. Concetti Fondamentali

## 2.1 Tunneling

Il **tunneling** è il processo fondamentale su cui si basa il funzionamento di una VPN. Consiste nell'incapsulare un protocollo di rete all'interno di un altro protocollo per trasmetterlo attraverso una rete incompatibile o non sicura.

### Come funziona il tunneling

```
[Dati Originali] → [Incapsulamento] → [Trasporto attraverso Internet] → [Decapsulamento] → [Dati Originali]
```

#### Processo step-by-step:
1. **Pacchetto originale**: il dato viene preparato con header IP standard
2. **Incapsulamento**: il pacchetto viene "wrappato" in un nuovo header
3. **Crittografia** (opzionale ma comune): il payload viene cifrato
4. **Trasmissione**: il pacchetto incapsulato viaggia attraverso la rete pubblica
5. **Ricezione**: il server VPN riceve il pacchetto
6. **Decapsulamento**: rimozione dell'header esterno
7. **Decrittazione**: recupero del payload originale
8. **Inoltro**: il pacchetto viene consegnato alla destinazione finale

### Esempio pratico

```
Pacchetto Originale:
[IP Header: 192.168.1.10 → 10.0.0.5] [TCP Header] [Dati: "GET /index.html"]

Dopo il tunneling:
[Nuovo IP Header: Client VPN → Server VPN] [VPN Header] [CRITTOGRAFIA[IP Header originale][TCP][Dati]]
```

### Tipi di tunnel
- **Tunnel Layer 2**: trasporta frame Ethernet (es. L2TP)
- **Tunnel Layer 3**: trasporta pacchetti IP (es. IPsec, GRE)
- **Tunnel Layer 4-7**: operano a livello applicativo (es. SSL/TLS VPN)

### Protocolli di tunneling comuni
- **GRE (Generic Routing Encapsulation)**: semplice ma non crittografato
- **IPsec**: complesso ma molto sicuro
- **L2TP**: spesso combinato con IPsec per la sicurezza
- **PPTP**: obsoleto, non più consigliato

## 2.2 Crittografia

La **crittografia** è il processo di trasformazione dei dati in un formato illeggibile (ciphertext) che può essere decifrato solo con la chiave corretta. È essenziale per garantire la confidenzialità dei dati trasmessi attraverso la VPN.

### Componenti della crittografia VPN

#### 1. Algoritmi di cifratura
Gli algoritmi più utilizzati nelle VPN moderne:

**AES (Advanced Encryption Standard)**
- Standard de facto per la sicurezza
- Chiavi: 128, 192, 256 bit
- AES-256 considerato inattaccabile con tecnologia attuale
- Veloce ed efficiente anche su hardware limitato

```
Esempio: AES-256-GCM (Galois/Counter Mode)
- Cifratura: AES-256 bit
- Modalità: GCM (autenticazione integrata)
- Performance: ~1-10 Gbps su hardware moderno
```

**Algoritmi legacy (da evitare)**
- **3DES**: lento, chiave effettiva solo 112 bit
- **Blowfish**: superato da algoritmi più moderni
- **RC4**: vulnerabile, deprecato

#### 2. Modalità di cifratura
- **CBC (Cipher Block Chaining)**: modalità classica, richiede IV
- **GCM (Galois/Counter Mode)**: moderna, con autenticazione integrata
- **CTR (Counter Mode)**: parallelizzabile, alta performance

#### 3. Cifratura simmetrica vs asimmetrica

**Cifratura Simmetrica** (utilizzata per il traffico)
- Stessa chiave per cifrare e decifrare
- Veloce ed efficiente
- Problema: distribuzione sicura delle chiavi
- Esempi: AES, ChaCha20

**Cifratura Asimmetrica** (utilizzata per scambio chiavi)
- Coppia di chiavi: pubblica e privata
- Lenta, usata solo per autenticazione e scambio chiavi
- Esempi: RSA, ECDSA, Ed25519

### Funzioni di Hash
Garantiscono l'integrità dei dati verificando che non siano stati modificati.

**Hash comuni**
- **SHA-256**: standard attuale, output 256 bit
- **SHA-384/512**: maggiore sicurezza, output più lungo
- **SHA-1**: obsoleto, vulnerabile a collisioni
- **MD5**: completamente deprecato

**HMAC (Hash-based Message Authentication Code)**
Combina hash crittografico con chiave segreta per autenticare e verificare l'integrità:
```
HMAC-SHA256 = Hash(chiave + messaggio)
```

## 2.3 Autenticazione

L'**autenticazione** verifica l'identità degli utenti e dei dispositivi che tentano di stabilire una connessione VPN. È cruciale per impedire accessi non autorizzati.

### Metodi di autenticazione

#### 1. Pre-Shared Key (PSK)
- Chiave condivisa configurata manualmente su entrambi i lati
- Semplice da implementare per piccole reti
- **Pro**: facile configurazione, nessuna infrastruttura PKI necessaria
- **Contro**: non scala bene, difficile gestione con molti utenti

```bash
# Esempio PSK in IPsec
conn myVPN
    authby=secret
    leftid=@vpnserver.example.com
    rightid=@client1
    # PSK definita in ipsec.secrets: @client1 : PSK "chiaveSegreta123!"
```

#### 2. Certificati Digitali (PKI)
Sistema più robusto basato su infrastruttura a chiave pubblica.

**Componenti PKI**
- **CA (Certificate Authority)**: emette e firma i certificati
- **Certificato digitale**: contiene chiave pubblica e informazioni identità
- **Chiave privata**: mantenuta segreta dal proprietario
- **CRL/OCSP**: verifica revoca certificati

**Vantaggi**
- Scalabilità per grandi organizzazioni
- Revoca centralizzata dei certificati
- Autenticazione reciproca (mutual authentication)
- Non richiede condivisione di segreti

```bash
# Generazione certificato con OpenSSL
openssl req -new -x509 -days 365 -nodes \
  -out server.crt -keyout server.key
```

#### 3. Username/Password
- Metodo più comune per utenti finali
- Spesso combinato con altri fattori
- Può integrarsi con directory aziendali (AD, LDAP)

#### 4. Multi-Factor Authentication (MFA)
Combinazione di più fattori:
- **Qualcosa che sai**: password, PIN
- **Qualcosa che hai**: token, smartphone, smart card
- **Qualcosa che sei**: biometria (impronta, face ID)

**Implementazioni comuni**
- TOTP (Time-based One-Time Password): Google Authenticator, Authy
- SMS OTP (sconsigliato per sicurezza)
- Hardware token: YubiKey, RSA SecurID
- Push notification: Duo, Microsoft Authenticator

#### 5. Protocolli di autenticazione

**RADIUS (Remote Authentication Dial-In User Service)**
- Protocollo AAA (Authentication, Authorization, Accounting)
- Centralizza autenticazione per multiple VPN
- Supporta vari metodi di autenticazione
- Logging centralizzato

```
[VPN Client] → [VPN Gateway] → [RADIUS Server] → [Active Directory/Database]
                     ↓
              Accesso concesso/negato
```

**TACACS+**
- Simile a RADIUS ma con maggiore controllo granulare
- Separa autenticazione, autorizzazione e accounting
- Più comune in ambiente Cisco

**LDAP/Active Directory**
- Integrazione con directory aziendale
- Gestione centralizzata utenti e gruppi
- Policies e permessi unificati

## 2.4 Incapsulamento

L'**incapsulamento** è il processo di inserimento di un intero pacchetto di rete all'interno del payload di un altro pacchetto.

### Livelli di incapsulamento

```
┌─────────────────────────────────────────┐
│  Header Esterno (Trasporto Internet)    │ ← Layer esterno
├─────────────────────────────────────────┤
│  Header VPN/Tunnel                      │ ← Layer VPN
├─────────────────────────────────────────┤
│  CRITTOGRAFIA {                         │
│    Header IP Originale                  │ ← Pacchetto originale
│    Header TCP/UDP                       │
│    Dati Applicativi                     │
│  }                                      │
└─────────────────────────────────────────┘
```

### Overhead dell'incapsulamento

Ogni layer aggiunge header, riducendo lo spazio per i dati effettivi:

```
MTU Standard Ethernet: 1500 byte
- IP header:           20 byte
- ESP header (IPsec):  ~50 byte
- Encryption overhead: ~16 byte
= MTU effettivo:       ~1414 byte
```

**Conseguenze**
- Necessità di frammentazione se payload troppo grande
- Riduzione del throughput effettivo
- Possibile degradazione performance

**Soluzioni**
- Path MTU Discovery (PMTUD)
- MSS Clamping
- Configurazione MTU ottimale sui client

## 2.5 VPN Client e VPN Server

### VPN Client

Il **VPN Client** è il software (o hardware) che inizia la connessione VPN dal lato utente.

#### Funzioni principali
1. **Inizializzazione della connessione**
   - Contatta il server VPN
   - Gestisce il processo di autenticazione
   - Negozia parametri di sicurezza

2. **Gestione del tunnel**
   - Incapsula il traffico di rete
   - Applica crittografia
   - Mantiene la connessione attiva (keepalive)

3. **Routing del traffico**
   - Decide quale traffico inviare attraverso il tunnel
   - Implementa split-tunneling se configurato
   - Gestisce tabelle di routing

#### Tipi di client
- **Client nativo OS**: integrato nel sistema operativo
- **Client standalone**: applicazione dedicata (OpenVPN GUI, Cisco AnyConnect)
- **Client browser**: WebVPN, clientless VPN
- **Client hardware**: router con VPN integrata

#### Configurazione tipica client
```bash
# Esempio configurazione OpenVPN client
client
dev tun
proto udp
remote vpn.example.com 1194
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca.crt
cert client.crt
key client.key
cipher AES-256-GCM
auth SHA256
verb 3
```

### VPN Server (VPN Gateway)

Il **VPN Server** (o Gateway) è il punto di accesso alla rete privata, che accetta e gestisce connessioni dai client.

#### Funzioni principali
1. **Accettare connessioni**
   - Listening su porte specifiche
   - Gestione di multiple connessioni simultanee
   - Load balancing tra server

2. **Autenticazione e autorizzazione**
   - Verifica credenziali utenti
   - Applica policies di accesso
   - Integrazione con sistemi AAA

3. **Gestione del traffico**
   - Decapsula pacchetti VPN
   - Instrada verso destinazioni interne
   - Applica firewall rules e ACL

4. **Monitoring e logging**
   - Traccia connessioni attive
   - Logging eventi di sicurezza
   - Statistiche utilizzo

#### Architetture server

**Single Server**
```
Internet → [VPN Server] → Internal Network
```
- Semplice ma single point of failure

**High Availability (HA)**
```
              ┌→ [VPN Server 1] ┐
Internet → LB ┤                 ├→ Internal Network
              └→ [VPN Server 2] ┘
```
- Ridondanza e maggiore capacità

**Geographically Distributed**
```
User US → [VPN Server US]    ┐
User EU → [VPN Server EU]    ├→ Corporate Network
User ASIA → [VPN Server ASIA]┘
```
- Latenza ridotta, disaster recovery

#### Requisiti hardware server
- **CPU**: potente per gestire crittografia (AES-NI support)
- **RAM**: sufficiente per connessioni simultanee
- **Network**: interfacce multiple, alta bandwidth
- **Storage**: per logging e configurazioni

### Interazione Client-Server

```
1. Client: Richiesta connessione → Server
2. Server: Challenge autenticazione → Client
3. Client: Credenziali → Server
4. Server: Verifica e genera chiavi sessione → Client
5. Client: Conferma parametri → Server
6. ═══ Tunnel VPN Stabilito ═══
7. Client: Traffico crittografato ⇄ Server
8. Server: Inoltra a rete interna/Internet
```

### Configurazione tipica server
```bash
# Esempio configurazione OpenVPN server
port 1194
proto udp
dev tun
ca ca.crt
cert server.crt
key server.key
dh dh2048.pem
server 10.8.0.0 255.255.255.0  # Subnet VPN
push "route 192.168.1.0 255.255.255.0"  # Route rete interna
push "dhcp-option DNS 8.8.8.8"
keepalive 10 120
cipher AES-256-GCM
auth SHA256
user nobody
group nogroup
persist-key
persist-tun
status openvpn-status.log
verb 3
```

---

**Capitolo precedente**: [01. Introduzione alle VPN](01.Introduzione_alle_VPN.md)  
**Prossimo capitolo**: [03. Tipologie di VPN](03.Tipologie_di_VPN.md)

# 7. Configurazione e Implementazione

Questa sezione fornisce guide pratiche step-by-step per configurare diverse soluzioni VPN su vari sistemi operativi e piattaforme.

## 7.1 Pianificazione di una rete VPN

Prima di implementare una VPN, è fondamentale pianificare attentamente l'architettura e i requisiti.

### Checklist di pianificazione

#### 1. Requisiti Business
```
□ Numero di utenti remoti (current + growth)
□ Numero di sedi da connettere
□ Tipi di applicazioni (latency-sensitive?)
□ Requisiti bandwidth per utente
□ SLA requirements (uptime, latency)
□ Budget disponibile (CAPEX + OPEX)
□ Compliance requirements (GDPR, HIPAA, PCI-DSS)
```

#### 2. Requisiti Tecnici
```
□ Tipologia VPN (Remote Access, Site-to-Site, entrambe)
□ Protocolli VPN (IPsec, OpenVPN, WireGuard)
□ Autenticazione (PSK, certificati, RADIUS, AD)
□ Encryption standard (AES-256, etc.)
□ Split vs Full tunneling
□ IPv4 + IPv6 support
□ Mobile devices support (iOS, Android)
```

#### 3. Network Design
```
□ IP addressing schema
  - VPN tunnel network: es. 10.8.0.0/16
  - On-premise networks: es. 192.168.0.0/16
  - Overlap check
□ DNS strategy
  - Push company DNS to clients?
  - Split-DNS configuration
□ Routing
  - Static routes
  - Dynamic routing (BGP, OSPF)
□ Firewall rules
  - Ingress (VPN ports)
  - Egress (from VPN to LAN)
```

#### 4. Sicurezza
```
□ Authentication method
□ MFA requirement
□ Certificate management (CA, renewal)
□ Logging and monitoring
□ IDS/IPS integration
□ Incident response plan
```

### Capacity Planning

**Formula utenti remote access:**
```
Concurrent Users = Total Users × Concurrency Factor

Esempio:
Total employees: 500
Typical concurrency: 30%
Peak concurrency: 50%

Average: 500 × 0.30 = 150 concurrent
Peak: 500 × 0.50 = 250 concurrent

→ Gateway sizing: 250 users × 1.2 (buffer) = 300 users capacity
```

**Bandwidth calculation:**
```
Per-user bandwidth: varies by application
- Email/web: 0.5-1 Mbps
- VoIP: 0.1 Mbps
- Video conferencing: 2-4 Mbps
- File transfers: variable (burst)

Average per user: 1 Mbps
Peak per user: 3 Mbps

Total bandwidth needed:
Average: 150 users × 1 Mbps = 150 Mbps
Peak: 250 users × 3 Mbps = 750 Mbps

→ Gateway: 1 Gbps link + hardware supporting 1 Gbps throughput
```

### Address Space Planning

```
Network Segmentation:

On-Premise:
- Corporate LAN: 192.168.0.0/16
  - Department A: 192.168.1.0/24
  - Department B: 192.168.2.0/24
  - Servers: 192.168.10.0/24

VPN Networks:
- Remote Access: 10.8.0.0/16
  - General users: 10.8.0.0/20
  - Contractors: 10.8.16.0/20
  - Guests: 10.8.32.0/20

Site-to-Site Tunnels:
- Branch Rome: 10.1.0.0/24 ← Tunnel → 10.2.0.0/30
- Branch Milan: 10.3.0.0/24 ← Tunnel → 10.2.0.4/30
```

**Evitare overlap!**
```bash
# Check for IP overlap
# Script check_overlap.sh
#!/bin/bash
networks=(
  "192.168.0.0/16"
  "10.8.0.0/16"
  "10.1.0.0/24"
  "10.3.0.0/24"
)

for ((i=0; i<${#networks[@]}; i++)); do
  for ((j=i+1; j<${#networks[@]}; j++)); do
    # Logic to check overlap
    echo "Checking ${networks[i]} vs ${networks[j]}"
  done
done
```

## 7.2 Requisiti hardware e software

### Server VPN Requirements

**Small deployment (< 100 users):**
```
CPU: 4 cores, 2.5+ GHz (con AES-NI)
RAM: 8 GB
Storage: 50 GB SSD
Network: 1 Gbps NIC
OS: Ubuntu 22.04 LTS o equivalente
```

**Medium deployment (100-1000 users):**
```
CPU: 8-16 cores, 3+ GHz (AES-NI)
RAM: 16-32 GB
Storage: 100 GB SSD (RAID 1 per HA)
Network: 10 Gbps NIC (dual per ridondanza)
OS: Ubuntu 22.04 LTS / RHEL 8
```

**Large deployment (1000+ users):**
```
CPU: 16+ cores, 3+ GHz (AES-NI mandatory)
RAM: 64+ GB
Storage: 500 GB SSD RAID 10
Network: 10 Gbps NIC (dual bonded)
Hardware acceleration: Crypto accelerator card
Load balancer: Dedicated appliance/software
```

### Software Requirements

**Ubuntu/Debian:**
```bash
# Base system
apt update && apt upgrade
apt install -y \
  build-essential \
  libssl-dev \
  net-tools \
  iptables \
  iptables-persistent

# OpenVPN
apt install -y openvpn easy-rsa

# strongSwan (IPsec)
apt install -y strongswan strongswan-pki libcharon-extra-plugins

# WireGuard
apt install -y wireguard
```

**CentOS/RHEL:**
```bash
# EPEL repo
yum install -y epel-release

# OpenVPN
yum install -y openvpn easy-rsa

# strongSwan
yum install -y strongswan

# WireGuard (RHEL 8+)
yum install -y wireguard-tools
```

### Network Prerequisites

**Firewall rules (ingress):**
```bash
# OpenVPN
ufw allow 1194/udp

# IPsec
ufw allow 500/udp    # IKE
ufw allow 4500/udp   # NAT-T
ufw allow esp        # ESP (protocol 50)

# WireGuard
ufw allow 51820/udp

# Management (restrict source!)
ufw allow from 192.168.1.0/24 to any port 22
```

**Kernel settings:**
```bash
# /etc/sysctl.conf
# IP Forwarding
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1

# Disable ICMP redirects
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# Disable source packet routing
net.ipv4.conf.all.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0

# Ignore ICMP ping
#net.ipv4.icmp_echo_ignore_all = 1

# Apply settings
sysctl -p
```

## 7.3 Configurazione IPsec su router Cisco

Esempio completo di configurazione Site-to-Site IPsec tra due router Cisco.

### Topologia
```
Site A                           Site B
192.168.1.0/24                   192.168.2.0/24
       │                                │
  ┌────▼─────┐                    ┌────▼─────┐
  │ Router A │   IPsec Tunnel     │ Router B │
  │ ASR 1001 │←──────────────────→│ ASR 1001 │
  └────┬─────┘                    └────┬─────┘
       │                                │
Public IP:                      Public IP:
203.0.113.1                     198.51.100.1
```

### Router A Configuration

```cisco
! ==========================================
! SITE A - Router Configuration
! ==========================================

hostname RouterA

! === ISAKMP (IKE Phase 1) Policy ===
crypto isakmp policy 10
 encr aes 256
 hash sha256
 authentication pre-share
 group 14
 lifetime 86400
!
crypto isakmp key Str0ngPr3Sh@redK3y! address 198.51.100.1

! === IPsec (Phase 2) Transform Set ===
crypto ipsec transform-set ESP-AES256-SHA256 esp-aes 256 esp-sha256-hmac
 mode tunnel
!

! === Define interesting traffic (ACL) ===
ip access-list extended VPN-TRAFFIC-SITE-B
 permit ip 192.168.1.0 0.0.0.255 192.168.2.0 0.0.0.255
!

! === Crypto Map ===
crypto map VPN-MAP 10 ipsec-isakmp
 set peer 198.51.100.1
 set transform-set ESP-AES256-SHA256
 set pfs group14
 match address VPN-TRAFFIC-SITE-B
!

! === Apply crypto map to interface ===
interface GigabitEthernet0/0/0
 description Internet Interface
 ip address 203.0.113.1 255.255.255.252
 no shut
 crypto map VPN-MAP
!

! === LAN Interface ===
interface GigabitEthernet0/0/1
 description LAN Interface
 ip address 192.168.1.1 255.255.255.0
 no shut
!

! === Static route to peer (if needed) ===
ip route 0.0.0.0 0.0.0.0 203.0.113.2

! === Route to remote network via tunnel ===
ip route 192.168.2.0 255.255.255.0 198.51.100.1
!

! === Optional: NAT exemption ===
ip access-list extended NAT-EXEMPT
 deny ip 192.168.1.0 0.0.0.255 192.168.2.0 0.0.0.255
 permit ip 192.168.1.0 0.0.0.255 any
!
ip nat inside source list NAT-EXEMPT interface GigabitEthernet0/0/0 overload

end
```

### Router B Configuration

```cisco
! ==========================================
! SITE B - Router Configuration
! ==========================================

hostname RouterB

! === ISAKMP (IKE Phase 1) Policy ===
crypto isakmp policy 10
 encr aes 256
 hash sha256
 authentication pre-share
 group 14
 lifetime 86400
!
crypto isakmp key Str0ngPr3Sh@redK3y! address 203.0.113.1

! === IPsec (Phase 2) Transform Set ===
crypto ipsec transform-set ESP-AES256-SHA256 esp-aes 256 esp-sha256-hmac
 mode tunnel
!

! === Define interesting traffic (ACL) ===
ip access-list extended VPN-TRAFFIC-SITE-A
 permit ip 192.168.2.0 0.0.0.255 192.168.1.0 0.0.0.255
!

! === Crypto Map ===
crypto map VPN-MAP 10 ipsec-isakmp
 set peer 203.0.113.1
 set transform-set ESP-AES256-SHA256
 set pfs group14
 match address VPN-TRAFFIC-SITE-A
!

! === Apply crypto map to interface ===
interface GigabitEthernet0/0/0
 description Internet Interface
 ip address 198.51.100.1 255.255.255.252
 no shut
 crypto map VPN-MAP
!

! === LAN Interface ===
interface GigabitEthernet0/0/1
 description LAN Interface
 ip address 192.168.2.1 255.255.255.0
 no shut
!

! === Static route to peer ===
ip route 0.0.0.0 0.0.0.0 198.51.100.2

! === Route to remote network via tunnel ===
ip route 192.168.1.0 255.255.255.0 203.0.113.1
!

! === NAT exemption ===
ip access-list extended NAT-EXEMPT
 deny ip 192.168.2.0 0.0.0.255 192.168.1.0 0.0.0.255
 permit ip 192.168.2.0 0.0.0.255 any
!
ip nat inside source list NAT-EXEMPT interface GigabitEthernet0/0/0 overload

end
```

### Verification Commands

```cisco
! Check ISAKMP SA (Phase 1)
show crypto isakmp sa

! Output example:
! dst             src             state          conn-id slot status
! 198.51.100.1    203.0.113.1     QM_IDLE           1001    0 ACTIVE

! Check IPsec SA (Phase 2)
show crypto ipsec sa

! Output shows:
! - Encaps/Decaps packet count
! - Current peer
! - Transform sets in use

! Check crypto engine
show crypto engine connections active

! Debug (use with caution)
debug crypto isakmp
debug crypto ipsec
! Remember to: undebug all
```

## 7.4 Configurazione OpenVPN

Guida completa per setup OpenVPN server con PKI su Ubuntu 22.04.

### Step 1: Installazione

```bash
# Update system
apt update && apt upgrade -y

# Install OpenVPN and Easy-RSA
apt install -y openvpn easy-rsa

# Create CA directory
make-cadir ~/openvpn-ca
cd ~/openvpn-ca
```

### Step 2: Configurare PKI

```bash
# Edit vars file
cat > vars << 'EOF'
set_var EASYRSA_REQ_COUNTRY    "IT"
set_var EASYRSA_REQ_PROVINCE   "Lombardia"
set_var EASYRSA_REQ_CITY       "Milano"
set_var EASYRSA_REQ_ORG        "MyCompany"
set_var EASYRSA_REQ_EMAIL      "admin@mycompany.com"
set_var EASYRSA_REQ_OU         "IT Department"
set_var EASYRSA_KEY_SIZE       2048
set_var EASYRSA_ALGO           rsa
set_var EASYRSA_CA_EXPIRE      3650
set_var EASYRSA_CERT_EXPIRE    365
EOF

# Initialize PKI
./easyrsa init-pki

# Build CA
./easyrsa build-ca nopass
# Enter Common Name: MyCompany-CA

# Generate server certificate
./easyrsa build-server-full server nopass

# Generate Diffie-Hellman parameters
./easyrsa gen-dh

# Generate TLS auth key
openvpn --genkey secret pki/ta.key

# Generate client certificates
./easyrsa build-client-full client1 nopass
./easyrsa build-client-full client2 nopass
```

### Step 3: Configurare Server

```bash
# Copy files to OpenVPN directory
cp pki/ca.crt /etc/openvpn/server/
cp pki/issued/server.crt /etc/openvpn/server/
cp pki/private/server.key /etc/openvpn/server/
cp pki/dh.pem /etc/openvpn/server/
cp pki/ta.key /etc/openvpn/server/

# Create server configuration
cat > /etc/openvpn/server/server.conf << 'EOF'
# OpenVPN Server Configuration

# Port and protocol
port 1194
proto udp
# Alternative for restrictive firewalls:
# port 443
# proto tcp

# Virtual network device
dev tun

# SSL/TLS certificates
ca ca.crt
cert server.crt
key server.key
dh dh.pem

# Network configuration
server 10.8.0.0 255.255.255.0

# Maintain a record of client-virtual IP address
ifconfig-pool-persist /var/log/openvpn/ipp.txt

# Push routes to client
push "route 192.168.1.0 255.255.255.0"
push "route 192.168.2.0 255.255.255.0"

# Push DNS servers
push "dhcp-option DNS 192.168.1.1"
push "dhcp-option DNS 8.8.8.8"

# (Optional) Push all traffic through VPN
# push "redirect-gateway def1 bypass-dhcp"

# Allow client-to-client communication
client-to-client

# Keepalive
keepalive 10 120

# Cryptographic cipher
cipher AES-256-GCM
auth SHA256

# TLS authentication
tls-crypt ta.key

# Compression (optional)
compress lz4-v2
push "compress lz4-v2"

# Maximum clients
max-clients 100

# Run OpenVPN with reduced privileges
user nobody
group nogroup

# Persist keys and TUN device
persist-key
persist-tun

# Logging
status /var/log/openvpn/openvpn-status.log
log-append /var/log/openvpn/openvpn.log
verb 3

# Explicit exit notify
explicit-exit-notify 1
EOF

# Create log directory
mkdir -p /var/log/openvpn
```

### Step 4: Network Configuration

```bash
# Enable IP forwarding
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sysctl -p

# Configure firewall (UFW)
ufw allow 1194/udp
ufw allow OpenSSH

# NAT configuration
# Find public interface (e.g., eth0)
PUBLIC_INTERFACE=$(ip route | grep default | awk '{print $5}')

# Add NAT rule
cat > /etc/ufw/before.rules.d/openvpn << EOF
# NAT table rules
*nat
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING -s 10.8.0.0/24 -o $PUBLIC_INTERFACE -j MASQUERADE
COMMIT
EOF

# Reload UFW
ufw disable && ufw enable
```

### Step 5: Avviare Server

```bash
# Enable and start OpenVPN
systemctl enable openvpn-server@server
systemctl start openvpn-server@server

# Check status
systemctl status openvpn-server@server

# Check logs
journalctl -u openvpn-server@server -f
```

### Step 6: Configurare Client

**Create client config:**
```bash
# Create client config directory
mkdir -p ~/client-configs/files

# Base client configuration
cat > ~/client-configs/base.conf << 'EOF'
client
dev tun
proto udp

# Server address
remote vpn.mycompany.com 1194

resolv-retry infinite
nobind

persist-key
persist-tun

# Certificates (embedded below)
remote-cert-tls server

cipher AES-256-GCM
auth SHA256

compress lz4-v2

verb 3
EOF

# Script to generate client config
cat > ~/client-configs/make_config.sh << 'EOF'
#!/bin/bash

CLIENT=$1
CADIR=~/openvpn-ca/pki

cat ~/client-configs/base.conf \
    <(echo -e '<ca>') \
    ${CADIR}/ca.crt \
    <(echo -e '</ca>\n<cert>') \
    ${CADIR}/issued/${CLIENT}.crt \
    <(echo -e '</cert>\n<key>') \
    ${CADIR}/private/${CLIENT}.key \
    <(echo -e '</key>\n<tls-crypt>') \
    ${CADIR}/ta.key \
    <(echo -e '</tls-crypt>') \
    > ~/client-configs/files/${CLIENT}.ovpn

echo "Client config created: ${CLIENT}.ovpn"
EOF

chmod +x ~/client-configs/make_config.sh

# Generate client configs
cd ~/client-configs
./make_config.sh client1
./make_config.sh client2
```

**Client installation:**

*Windows:*
```
1. Download OpenVPN GUI from openvpn.net
2. Install OpenVPN
3. Copy client1.ovpn to C:\Program Files\OpenVPN\config\
4. Run OpenVPN GUI as Administrator
5. Right-click system tray icon → Connect
```

*Linux:*
```bash
apt install openvpn
openvpn --config client1.ovpn
```

*macOS:*
```
1. Install Tunnelblick
2. Double-click client1.ovpn
3. Connect from menu bar
```

*Mobile (Android/iOS):*
```
1. Install OpenVPN Connect app
2. Import client1.ovpn file
3. Connect
```

## 7.5 Configurazione WireGuard

WireGuard è un protocollo VPN moderno, veloce e semplice da configurare.

### Installazione

```bash
# Ubuntu 20.04+
apt update
apt install -y wireguard

# Generate keys
cd /etc/wireguard
umask 077
wg genkey | tee server_private.key | wg pubkey > server_public.key
wg genkey | tee client1_private.key | wg pubkey > client1_public.key
```

### Server Configuration

```bash
# /etc/wireguard/wg0.conf
cat > /etc/wireguard/wg0.conf << EOF
[Interface]
Address = 10.99.0.1/24
ListenPort = 51820
PrivateKey = $(cat server_private.key)

# Post-up and post-down scripts
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

# Client 1
[Peer]
PublicKey = $(cat client1_public.key)
AllowedIPs = 10.99.0.2/32

# Client 2
# [Peer]
# PublicKey = <client2_public_key>
# AllowedIPs = 10.99.0.3/32
EOF

# Set permissions
chmod 600 /etc/wireguard/wg0.conf
```

### Client Configuration

```bash
# client1.conf
[Interface]
Address = 10.99.0.2/24
PrivateKey = <client1_private_key>
DNS = 8.8.8.8

[Peer]
PublicKey = <server_public_key>
Endpoint = vpn.mycompany.com:51820
AllowedIPs = 0.0.0.0/0  # Route all traffic through VPN
# AllowedIPs = 10.99.0.0/24, 192.168.1.0/24  # Split-tunnel
PersistentKeepalive = 25
```

### Enable and Start

```bash
# Enable IP forwarding
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sysctl -p

# Firewall
ufw allow 51820/udp

# Start WireGuard
wg-quick up wg0

# Enable at boot
systemctl enable wg-quick@wg0

# Check status
wg show wg0
```

### QR Code per Mobile

```bash
# Install qrencode
apt install qrencode

# Generate QR code
qrencode -t ansiutf8 < client1.conf
```

## 7.6 VPN su Linux (strongSwan, OpenVPN)

### strongSwan IPsec Configuration

**Server (strongSwan):**
```bash
# Install
apt install strongswan strongswan-pki libcharon-extra-plugins

# Generate certificates
cd /etc/ipsec.d

# CA certificate
ipsec pki --gen --type rsa --size 4096 --outform pem > private/ca-key.pem
ipsec pki --self --ca --lifetime 3650 --in private/ca-key.pem \
    --type rsa --dn "CN=VPN CA" --outform pem > cacerts/ca-cert.pem

# Server certificate
ipsec pki --gen --type rsa --size 2048 --outform pem > private/server-key.pem
ipsec pki --pub --in private/server-key.pem --type rsa | \
    ipsec pki --issue --lifetime 365 --cacert cacerts/ca-cert.pem \
    --cakey private/ca-key.pem --dn "CN=vpn.mycompany.com" \
    --san vpn.mycompany.com --flag serverAuth --flag ikeIntermediate \
    --outform pem > certs/server-cert.pem

# Client certificate
ipsec pki --gen --type rsa --size 2048 --outform pem > private/client-key.pem
ipsec pki --pub --in private/client-key.pem --type rsa | \
    ipsec pki --issue --lifetime 365 --cacert cacerts/ca-cert.pem \
    --cakey private/ca-key.pem --dn "CN=client" \
    --outform pem > certs/client-cert.pem
```

**/etc/ipsec.conf:**
```
config setup
    charondebug="ike 2, knl 2, cfg 2, net 2"
    uniqueids=never

conn %default
    keyexchange=ikev2
    ike=aes256-sha256-modp2048!
    esp=aes256-sha256!
    dpdaction=clear
    dpddelay=300s
    rekey=no

conn rw
    left=%any
    leftid=@vpn.mycompany.com
    leftcert=server-cert.pem
    leftsubnet=0.0.0.0/0
    right=%any
    rightid=%any
    rightsourceip=10.10.10.0/24
    auto=add
```

**/etc/ipsec.secrets:**
```
: RSA server-key.pem
```

**Start:**
```bash
systemctl enable strongswan-starter
systemctl start strongswan-starter
ipsec statusall
```

## 7.7 VPN su Windows Server

### Windows Built-in VPN (RRAS)

**Install Role:**
```powershell
# PowerShell as Administrator
Install-WindowsFeature RemoteAccess -IncludeManagementTools
Install-WindowsFeature DirectAccess-VPN -IncludeManagementTools
Install-WindowsFeature Routing -IncludeManagementTools

# Configure RRAS
Install-RemoteAccess -VpnType Vpn
```

**Configure via GUI:**
```
1. Open "Routing and Remote Access"
2. Right-click server → Configure and Enable Routing and Remote Access
3. Select "Remote access (dial-up or VPN)"
4. Select VPN protocols (PPTP, L2TP/IPsec, SSTP, IKEv2)
5. Configure IP address pool
6. Choose authentication (Windows, RADIUS)
```

**Configure IP pool:**
```powershell
Set-RemoteAccessIpFilter -InterfaceAlias "Internal" `
    -AddressRange @("192.168.1.0/24")
```

## 7.8 VPN su dispositivi mobili

### iOS Configuration

**Manual L2TP/IPsec:**
```
Settings → VPN → Add VPN Configuration
Type: L2TP
Description: Company VPN
Server: vpn.company.com
Account: username
RSA SecurID: OFF
Password: password
Secret: <shared secret>
Send All Traffic: ON
```

**IKEv2 (strongSwan):**
```
Install profile (mobileconfig file)
Or manually:
Settings → VPN → Add VPN Configuration
Type: IKEv2
Description: Company VPN
Server: vpn.company.com
Remote ID: vpn.company.com
Local ID: user@company.com
User Authentication: Certificate
Certificate: Install user certificate
```

### Android Configuration

**OpenVPN for Android:**
```
1. Install "OpenVPN for Android"
2. Import .ovpn file
3. Tap to connect
```

**Built-in IPsec:**
```
Settings → Network & Internet → VPN
+ Add VPN
Name: Company VPN
Type: IPsec Xauth PSK
Server address: vpn.company.com
IPsec identifier: <leave blank for domain>
IPsec pre-shared key: <PSK>
Username: user
Password: password
```

**WireGuard:**
```
1. Install WireGuard app
2. Import config file or scan QR code
3. Toggle connection
```

---

**Capitolo precedente**: [06. Architetture VPN](06.Architetture_VPN.md)  
**Prossimo capitolo**: [08. QoS e Performance](08.QoS_e_Performance.md)

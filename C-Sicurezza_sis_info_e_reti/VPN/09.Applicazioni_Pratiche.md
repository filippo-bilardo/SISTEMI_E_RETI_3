# 9. Applicazioni Pratiche

Le VPN hanno numerose applicazioni nel mondo reale, dal business all'uso personale. Questo capitolo esplora i casi d'uso più comuni e come implementarli efficacemente.

## 9.1 Accesso remoto per smart working

### Architettura tipica

```
Home Office Workers          Branch Office
       │                           │
       │ OpenVPN/IPsec             │ Site-to-Site VPN
       │                           │
       ▼                           ▼
    ┌────────────────────────────────┐
    │      VPN Gateway Cluster       │
    │    (Active/Active HA)          │
    └────────────┬───────────────────┘
                 │
    ┌────────────▼───────────────────┐
    │    Corporate Network           │
    │                                │
    │  ┌──────────────────────────┐  │
    │  │ File Servers             │  │
    │  │ Email (Exchange)         │  │
    │  │ ERP/CRM Systems          │  │
    │  │ Internal Web Apps        │  │
    │  │ Database Servers         │  │
    │  └──────────────────────────┘  │
    └────────────────────────────────┘
```

### Caso d'uso: Azienda 500 dipendenti

**Requisiti:**
- 500 dipendenti totali
- 40% smart working (200 concurrent users peak)
- Accesso a: File server, email, ERP, intranet
- Multi-platform: Windows, macOS, Linux, mobile
- MFA obbligatorio

**Soluzione implementata:**

```yaml
# Architettura
VPN_Solution: OpenVPN
Authentication: LDAP/Active Directory + Google Authenticator (TOTP)
High_Availability: 3 x OpenVPN servers (load balanced)
Capacity: 250 users per server (750 total)
Network: 10 Gbps uplink, 2 Gbps VPN throughput
Monitoring: Grafana + Prometheus
```

**Configurazione OpenVPN server:**
```bash
# /etc/openvpn/server/company.conf

port 1194
proto udp
dev tun

# HA - listening on specific IP
local 10.0.1.10  # Server 1: 10.0.1.10, Server 2: 10.0.1.11, etc.

# Certificates
ca /etc/openvpn/pki/ca.crt
cert /etc/openvpn/pki/issued/server1.crt
key /etc/openvpn/pki/private/server1.key
dh /etc/openvpn/pki/dh.pem

# Network
server 10.8.0.0 255.255.252.0  # /22 = 1022 usable IPs

# Routes to corporate network
push "route 192.168.0.0 255.255.0.0"  # Corporate LAN
push "route 10.10.0.0 255.255.0.0"    # Data center

# DNS
push "dhcp-option DNS 192.168.1.10"   # Internal DNS
push "dhcp-option DOMAIN company.local"

# Split tunneling (only corporate traffic via VPN)
route-nopull  # Don't push default gateway

# Authentication via plugin
plugin /usr/lib/openvpn/openvpn-plugin-auth-pam.so login

# MFA integration (Google Authenticator)
plugin /usr/lib/openvpn/openvpn-otp.so

# Security
cipher AES-256-GCM
auth SHA256
tls-version-min 1.2

# Performance
sndbuf 393216
rcvbuf 393216
push "sndbuf 393216"
push "rcvbuf 393216"

# Client config directory (per-user settings)
client-config-dir /etc/openvpn/ccd

# Logging
status /var/log/openvpn/status.log 10
log-append /var/log/openvpn/company.log
verb 3

# Max clients
max-clients 250

# Privileges
user nobody
group nogroup
persist-key
persist-tun
```

**Per-user configuration (CCD):**
```bash
# /etc/openvpn/ccd/alice
# Assign static IP
ifconfig-push 10.8.0.100 255.255.252.0

# Custom routes for IT dept
push "route 192.168.250.0 255.255.255.0"

# /etc/openvpn/ccd/contractor_bob
# Limited access - only to specific subnet
iroute 192.168.100.0 255.255.255.0
```

**MFA Integration (PAM + Google Authenticator):**
```bash
# Install Google Authenticator
apt install libpam-google-authenticator

# Each user generates their secret
google-authenticator

# PAM configuration (/etc/pam.d/openvpn)
auth required pam_google_authenticator.so
account required pam_unix.so
```

### Client deployment

**Windows deployment (GPO):**
```powershell
# Deploy via Group Policy
# 1. Create MSI package of OpenVPN installer + config
# 2. GPO Software Installation
Computer Configuration → Policies → Software Settings → Software Installation
→ Add company-vpn.msi

# Silent install script
msiexec /i OpenVPN-2.6.8-I001-amd64.msi /quiet /norestart
Copy-Item \\fileserver\vpn\company.ovpn "$env:ProgramFiles\OpenVPN\config\"
```

**macOS deployment (MDM):**
```xml
<!-- VPN configuration profile -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>PayloadContent</key>
    <array>
        <dict>
            <key>PayloadType</key>
            <string>com.apple.vpn.managed</string>
            <key>PayloadIdentifier</key>
            <string>com.company.vpn</string>
            <key>VPNType</key>
            <string>OpenVPN</string>
            <key>UserDefinedName</key>
            <string>Company VPN</string>
            <key>VPN</key>
            <dict>
                <key>RemoteAddress</key>
                <string>vpn.company.com</string>
            </dict>
        </dict>
    </array>
</dict>
</plist>
```

### Monitoraggio e reportistica

**Dashboard metrics:**
```python
# Prometheus exporter for OpenVPN
# /opt/openvpn_exporter.py

from prometheus_client import start_http_server, Gauge
import re
import time

active_connections = Gauge('openvpn_active_connections', 'Number of active VPN connections')
bytes_received = Gauge('openvpn_bytes_received', 'Bytes received', ['user'])
bytes_sent = Gauge('openvpn_bytes_sent', 'Bytes sent', ['user'])

def parse_status():
    with open('/var/log/openvpn/status.log', 'r') as f:
        content = f.read()
        # Parse connection count
        connections = len(re.findall(r'^CLIENT_LIST', content, re.M))
        active_connections.set(connections)
        
        # Parse per-user stats
        for line in content.split('\n'):
            if line.startswith('CLIENT_LIST'):
                parts = line.split(',')
                user = parts[1]
                bytes_rx = int(parts[5])
                bytes_tx = int(parts[6])
                bytes_received.labels(user=user).set(bytes_rx)
                bytes_sent.labels(user=user).set(bytes_tx)

if __name__ == '__main__':
    start_http_server(9176)
    while True:
        parse_status()
        time.sleep(60)
```

## 9.2 Collegamento tra sedi aziendali

### Site-to-Site VPN: Multi-branch deployment

**Scenario:**
- Sede principale: Milano (HQ)
- Filiali: Roma, Torino, Napoli
- Datacenter: Cloud AWS Frankfurt

```
                    ┌──────────────┐
                    │  Milano HQ   │
                    │192.168.1.0/24│
                    └──────┬───────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼─────┐      ┌────▼─────┐      ┌────▼─────┐
   │   Roma   │      │  Torino  │      │  Napoli  │
   │192.168.2.│      │192.168.3.│      │192.168.4.│
   │   .0/24  │      │   .0/24  │      │   .0/24  │
   └──────────┘      └──────────┘      └──────────┘
        │
        └────────────────────────────────────┐
                                             │
                                        ┌────▼──────┐
                                        │ AWS VPC   │
                                        │10.0.0.0/16│
                                        └───────────┘
```

**Implementation: Hub-and-Spoke strongSwan**

**Milano (Hub):**
```bash
# /etc/ipsec.conf
config setup
    charondebug="ike 2, knl 2, cfg 2"
    uniqueids=no

conn %default
    keyexchange=ikev2
    ike=aes256-sha256-modp2048!
    esp=aes256-sha256!
    dpdaction=restart
    dpddelay=30s

# Connection to Roma
conn to-roma
    left=203.0.113.10          # Milano public IP
    leftid=@milano.company.com
    leftsubnet=192.168.1.0/24
    right=198.51.100.20        # Roma public IP
    rightid=@roma.company.com
    rightsubnet=192.168.2.0/24
    authby=secret
    auto=start

# Connection to Torino
conn to-torino
    left=203.0.113.10
    leftid=@milano.company.com
    leftsubnet=192.168.1.0/24
    right=198.51.100.30
    rightid=@torino.company.com
    rightsubnet=192.168.3.0/24
    authby=secret
    auto=start

# Connection to Napoli
conn to-napoli
    left=203.0.113.10
    leftid=@milano.company.com
    leftsubnet=192.168.1.0/24
    right=198.51.100.40
    rightid=@napoli.company.com
    rightsubnet=192.168.4.0/24
    authby=secret
    auto=start

# /etc/ipsec.secrets
@milano.company.com @roma.company.com : PSK "SecureKey-Milano-Roma-2024"
@milano.company.com @torino.company.com : PSK "SecureKey-Milano-Torino-2024"
@milano.company.com @napoli.company.com : PSK "SecureKey-Milano-Napoli-2024"
```

**Routing configuration (Milano):**
```bash
# Static routes to remote branches
ip route add 192.168.2.0/24 via 198.51.100.20  # Roma
ip route add 192.168.3.0/24 via 198.51.100.30  # Torino
ip route add 192.168.4.0/24 via 198.51.100.40  # Napoli

# Persistent (add to /etc/network/interfaces or netplan)
```

**Spoke configuration (Roma):**
```bash
# /etc/ipsec.conf
conn to-milano
    left=198.51.100.20         # Roma public IP
    leftid=@roma.company.com
    leftsubnet=192.168.2.0/24
    right=203.0.113.10         # Milano public IP
    rightid=@milano.company.com
    rightsubnet=192.168.1.0/24
    authby=secret
    auto=start

# /etc/ipsec.secrets
@roma.company.com @milano.company.com : PSK "SecureKey-Milano-Roma-2024"
```

### Dynamic routing with BGP

Per topologie complesse, usare routing dinamico.

```bash
# Install FRRouting
apt install frr

# /etc/frr/frr.conf
!
router bgp 65001
  bgp router-id 192.168.1.1
  neighbor 192.168.2.1 remote-as 65002
  neighbor 192.168.3.1 remote-as 65003
  neighbor 192.168.4.1 remote-as 65004
  !
  address-family ipv4 unicast
    network 192.168.1.0/24
    neighbor 192.168.2.1 activate
    neighbor 192.168.3.1 activate
    neighbor 192.168.4.1 activate
  exit-address-family
!
```

## 9.3 Bypassare geo-restriction

**Nota:** Verificare sempre i termini di servizio. Alcuni servizi vietano l'uso di VPN.

### Use case: Accesso a contenuti regionali

```
User in Italy → VPN Server in US → Netflix US library
User in China → VPN Server in Singapore → Unrestricted Internet
Traveler in UAE → VPN Home → Corporate resources
```

### Setup VPN per geo-unblocking

**OpenVPN configuration:**
```bash
# Full tunnel (all traffic via VPN)
push "redirect-gateway def1"

# DNS to prevent leaks
push "dhcp-option DNS 8.8.8.8"
push "block-outside-dns"  # Windows DNS leak prevention
```

**WireGuard configuration:**
```ini
[Interface]
PrivateKey = <client_private_key>
Address = 10.0.0.2/32
DNS = 1.1.1.1

[Peer]
PublicKey = <server_public_key>
Endpoint = us-server.vpnprovider.com:51820
AllowedIPs = 0.0.0.0/0, ::/0  # Route all traffic
PersistentKeepalive = 25
```

### Evitare detection VPN

Alcuni servizi bloccano IP noti di provider VPN.

**Strategie:**
1. **IP residenziali**: Usare IP "residenziali" invece che datacenter
2. **Port obfuscation**: OpenVPN su porta 443 TCP (sembra HTTPS)
3. **Obfsproxy**: Offuscamento traffico VPN

```bash
# OpenVPN on port 443 TCP
port 443
proto tcp

# Stunnel wrapper (appare come SSL)
apt install stunnel4

# /etc/stunnel/openvpn.conf
[openvpn]
accept = 443
connect = 127.0.0.1:1194
cert = /etc/stunnel/stunnel.pem
```

## 9.4 Protezione su reti WiFi pubbliche

### Rischi WiFi pubblico

```
Attacker on same WiFi ←→ Unencrypted traffic ←→ Victim
                              │
                              ↓
                        - Credentials
                        - Session cookies
                        - Private data
```

**Attacchi comuni:**
- Packet sniffing (Wireshark)
- Man-in-the-Middle (ARP spoofing, DNS spoofing)
- Evil twin (fake WiFi hotspot)
- Session hijacking

### Protezione con VPN

```
User device → Encrypted VPN tunnel → Internet
     │                                    │
WiFi hotspot can't see:                   ↓
- Websites visited                    Real websites
- Credentials                         Secure access
- Data transferred
```

**Always-on VPN configuration (iOS/Android):**

*iOS:*
```
Settings → VPN → Connect on Demand
Rules:
- SSID matches "CoffeeShop-WiFi" → Connect
- SSID matches "Airport-Free-WiFi" → Connect
- Cellular → Disconnect
```

*Android (VPN always-on):*
```
Settings → Network & Internet → VPN → ⚙️
→ Always-on VPN: ON
→ Block connections without VPN: ON
```

**Kill switch implementation:**
```bash
# Linux - block all traffic if VPN down
# /etc/openvpn/killswitch.sh

#!/bin/bash
iptables -F
iptables -X
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP

# Allow local network
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# Allow VPN connection establishment
iptables -A OUTPUT -p udp --dport 1194 -j ACCEPT
iptables -A INPUT -p udp --sport 1194 -j ACCEPT

# Allow traffic on VPN interface
iptables -A INPUT -i tun0 -j ACCEPT
iptables -A OUTPUT -o tun0 -j ACCEPT

# Block everything else
iptables -A OUTPUT -j REJECT
iptables -A INPUT -j REJECT
```

## 9.5 VPN per IoT

### Challenges IoT

- Dispositivi limitati (CPU, RAM)
- Connessioni intermittenti
- Numero elevato di dispositivi
- Security patching difficile

### Architecture IoT VPN

```
IoT Devices (home/remote)
     │
     │ WireGuard (lightweight)
     │
     ▼
IoT VPN Gateway (cloud)
     │
     ▼
Management Platform
     │
     ├─ Device monitoring
     ├─ OTA updates
     ├─ Data collection
     └─ Remote control
```

### WireGuard per IoT

**Server configuration:**
```ini
# /etc/wireguard/iot0.conf
[Interface]
Address = 10.100.0.1/16
ListenPort = 51820
PrivateKey = <server_private_key>

# PostUp script to allow IoT to communicate
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT

# IoT Device 1 (sensor)
[Peer]
PublicKey = <device1_public_key>
AllowedIPs = 10.100.0.10/32

# IoT Device 2 (camera)
[Peer]
PublicKey = <device2_public_key>
AllowedIPs = 10.100.0.11/32

# ... more devices
```

**IoT device configuration (embedded Linux):**
```ini
# /etc/wireguard/wg0.conf
[Interface]
Address = 10.100.0.10/32
PrivateKey = <device_private_key>

[Peer]
PublicKey = <server_public_key>
Endpoint = iot-vpn.company.com:51820
AllowedIPs = 10.100.0.0/16  # Access to other IoT devices
PersistentKeepalive = 25    # Keep NAT mapping alive
```

### Zero-Trust IoT Network

```
Principles:
1. Each device = unique identity (certificate/key)
2. Least privilege access
3. Device attestation
4. Encrypted communication mandatory
5. Continuous monitoring

Implementation:
- WireGuard mesh network
- mTLS for application layer
- Device certificates with short expiry
- Network segmentation
```

## 9.6 VPN per streaming e P2P

### Streaming use cases

**Problemi senza VPN:**
- ISP throttling (riduzione bandwidth per streaming)
- Geo-blocking dei contenuti
- Privacy (ISP tracking viewing habits)

**Soluzione VPN:**
```
User → VPN (no throttling) → Streaming service
     └─ ISP sees encrypted traffic, can't throttle specific service
```

**Performance tuning per streaming:**
```bash
# OpenVPN optimized for streaming
cipher AES-128-GCM      # Faster than AES-256
sndbuf 524288           # Large buffers
rcvbuf 524288
fast-io                 # Reduce context switches
fragment 0              # No fragmentation
mssfix 0               # Auto MSS
```

**Server selection:**
- Scegliere server geograficamente vicino a streaming service
- Preferire server con bassa latenza (<30ms)
- Evitare server sovraccarichi

### P2P/Torrenting

**Port forwarding per P2P:**
```bash
# OpenVPN - forward port range to client
# Server config
port-share localhost 8080  # If on port 443

# Client-specific config (CCD)
# /etc/openvpn/ccd/torrent-user
iroute 192.168.100.0 255.255.255.0
push "route 192.168.100.0 255.255.255.0"

# Port forward setup (iptables on server)
iptables -t nat -A PREROUTING -p tcp --dport 50000:50010 \
    -j DNAT --to-destination 10.8.0.100:50000-50010
```

**Bind P2P client to VPN interface:**
```python
# qBittorrent settings
Options → Advanced → Network Interface: tun0

# Transmission settings.json
"bind-address-ipv4": "10.8.0.100",
"rpc-bind-address": "127.0.0.1",
```

**Kill switch essenziale per P2P:**
```bash
# Se VPN cade, blocca tutto il traffico P2P
# Evita di esporre real IP

# Check VPN is up before starting torrent client
#!/bin/bash
while true; do
    if ip link show tun0 | grep -q "state UP"; then
        echo "VPN is up, starting torrent client"
        transmission-daemon
        break
    else
        echo "Waiting for VPN..."
        sleep 5
    fi
done
```

### DNS-over-VPN per privacy

```bash
# Force all DNS through VPN
# OpenVPN server config
push "dhcp-option DNS 10.8.0.1"
push "block-outside-dns"

# Setup DNS server on VPN gateway (Unbound)
apt install unbound

# /etc/unbound/unbound.conf
server:
    interface: 10.8.0.1
    access-control: 10.8.0.0/24 allow
    do-not-query-localhost: no
    hide-identity: yes
    hide-version: yes

forward-zone:
    name: "."
    forward-addr: 1.1.1.1@853  # DNS-over-TLS
    forward-addr: 9.9.9.9@853
```

---

**Capitolo precedente**: [08. QoS e Performance](08.QoS_e_Performance.md)  
**Prossimo capitolo**: [10. VPN e Networking](10.VPN_e_Networking.md)

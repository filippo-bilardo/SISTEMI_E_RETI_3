# 11. VPN Cloud e Servizi Commerciali

## Introduzione

Con la crescente adozione del cloud computing, le VPN si sono evolute oltre le tradizionali soluzioni on-premise. I principali cloud provider offrono servizi VPN gestiti per connettere reti on-premise al cloud, mentre esistono numerosi servizi VPN commerciali per utenti finali. Questo capitolo esplora entrambe le categorie.

## 11.1 AWS VPN

### 11.1.1 AWS Site-to-Site VPN

Connette la rete on-premise alla VPC (Virtual Private Cloud) AWS.

```
On-Premise Network          AWS VPC
192.168.0.0/16             10.0.0.0/16
       |                        |
Customer Gateway    ←→    Virtual Private Gateway
   (CGW)                      (VGW)
       |                        |
     IPsec Tunnels (2x redundant)
```

**Architettura**:
- **Customer Gateway (CGW)**: Dispositivo fisico/virtuale on-premise
- **Virtual Private Gateway (VGW)**: Endpoint VPN lato AWS
- **Tunnel**: 2 tunnel IPsec ridondanti (attivo/attivo)

**Configurazione AWS**:

```bash
# 1. Crea Virtual Private Gateway
aws ec2 create-vpn-gateway --type ipsec.1 --amazon-side-asn 64512

# 2. Attacca VGW alla VPC
aws ec2 attach-vpn-gateway \
    --vpn-gateway-id vgw-12345678 \
    --vpc-id vpc-abcdef01

# 3. Crea Customer Gateway (specificando IP pubblico on-premise)
aws ec2 create-customer-gateway \
    --type ipsec.1 \
    --public-ip 203.0.113.100 \
    --bgp-asn 65000

# 4. Crea VPN Connection
aws ec2 create-vpn-connection \
    --type ipsec.1 \
    --customer-gateway-id cgw-87654321 \
    --vpn-gateway-id vgw-12345678 \
    --options TunnelOptions='[{TunnelInsideCidr=169.254.10.0/30,PreSharedKey=MySecureKey123}]'

# 5. Download configurazione per dispositivo on-premise
aws ec2 describe-vpn-connections \
    --vpn-connection-ids vpn-11223344 \
    --query 'VpnConnections[0].CustomerGatewayConfiguration' \
    --output text > vpn-config.txt
```

**Configurazione strongSwan (Customer Gateway)**:

```bash
# /etc/ipsec.conf
conn aws-tunnel-1
    left=%defaultroute
    leftid=203.0.113.100
    leftsubnet=192.168.0.0/16
    
    right=52.1.2.3              # AWS tunnel 1 endpoint
    rightsubnet=10.0.0.0/16
    
    authby=secret
    ike=aes256-sha2_256-modp2048!
    esp=aes256-sha2_256!
    
    keyexchange=ikev2
    ikelifetime=28800s
    lifetime=3600s
    
    dpdaction=restart
    dpddelay=10s
    dpdtimeout=30s
    
    auto=start

conn aws-tunnel-2
    also=aws-tunnel-1
    right=54.2.3.4              # AWS tunnel 2 endpoint

# /etc/ipsec.secrets
203.0.113.100 52.1.2.3 : PSK "MySecureKey123"
203.0.113.100 54.2.3.4 : PSK "MySecureKey456"
```

**Routing con BGP**:

```bash
# /etc/frr/bgpd.conf
router bgp 65000
 bgp router-id 203.0.113.100
 
 # Tunnel 1
 neighbor 169.254.10.1 remote-as 64512
 neighbor 169.254.10.1 timers 10 30
 
 # Tunnel 2
 neighbor 169.254.11.1 remote-as 64512
 neighbor 169.254.11.1 timers 10 30
 
 # Announce on-premise networks
 network 192.168.0.0/16
 
 # Path selection
 bgp bestpath as-path multipath-relax
 maximum-paths 2
```

### 11.1.2 AWS Client VPN

VPN gestita per accesso remoto individuale.

**Caratteristiche**:
- Basato su OpenVPN
- Autenticazione: AD, SAML, certificati
- Scalabile automaticamente
- Pay-per-use ($/ora endpoint + $/GB traffico)

**Setup via Terraform**:

```hcl
# client-vpn.tf
resource "aws_ec2_client_vpn_endpoint" "main" {
  description            = "Company Client VPN"
  server_certificate_arn = aws_acm_certificate.vpn_server.arn
  client_cidr_block      = "10.200.0.0/22"  # IP pool per client
  
  authentication_options {
    type                       = "certificate-authentication"
    root_certificate_chain_arn = aws_acm_certificate.vpn_client_root.arn
  }
  
  connection_log_options {
    enabled               = true
    cloudwatch_log_group  = aws_cloudwatch_log_group.vpn.name
    cloudwatch_log_stream = aws_cloudwatch_log_stream.vpn.name
  }
  
  split_tunnel = true  # Solo traffico VPC via tunnel
  
  vpc_id             = aws_vpc.main.id
  security_group_ids = [aws_security_group.vpn.id]
  
  dns_servers = ["10.0.0.2"]  # VPC DNS resolver
}

# Associa a subnet per accesso
resource "aws_ec2_client_vpn_network_association" "main" {
  client_vpn_endpoint_id = aws_ec2_client_vpn_endpoint.main.id
  subnet_id              = aws_subnet.private_a.id
}

# Authorization rule
resource "aws_ec2_client_vpn_authorization_rule" "all" {
  client_vpn_endpoint_id = aws_ec2_client_vpn_endpoint.main.id
  target_network_cidr    = "10.0.0.0/16"
  authorize_all_groups   = true
}

# Output config file URL
output "vpn_config_url" {
  value = "https://console.aws.amazon.com/vpc/home#ClientVPNEndpoints:ClientVpnEndpointId=${aws_ec2_client_vpn_endpoint.main.id}"
}
```

**Monitoring con CloudWatch**:

```bash
# Query logs
aws logs filter-log-events \
    --log-group-name /aws/clientvpn \
    --filter-pattern "connection-attempt" \
    --start-time $(date -d '1 hour ago' +%s)000

# Metrics
aws cloudwatch get-metric-statistics \
    --namespace AWS/ClientVPN \
    --metric-name ActiveConnectionsCount \
    --dimensions Name=Endpoint,Value=cvpn-endpoint-12345 \
    --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
    --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
    --period 300 \
    --statistics Average
```

### 11.1.3 AWS Transit Gateway con VPN

Per connettere multiple VPC e reti on-premise:

```
                Transit Gateway
                      |
        +-------------+-------------+
        |             |             |
     VPC-A         VPC-B     Site-to-Site VPN
   10.0.0.0/16  10.1.0.0/16   (on-premise)
                               192.168.0.0/16
```

**Vantaggi**:
- Hub centrale per routing
- Peering tra VPC semplificato
- Unico punto VPN per tutte le VPC

## 11.2 Azure VPN Gateway

### 11.2.1 Azure Site-to-Site VPN

```bash
# Azure CLI - Creare VPN Gateway

# 1. Crea Virtual Network
az network vnet create \
    --resource-group MyResourceGroup \
    --name VNet1 \
    --address-prefix 10.1.0.0/16 \
    --subnet-name GatewaySubnet \
    --subnet-prefix 10.1.255.0/27

# 2. Richiedi Public IP per VPN Gateway
az network public-ip create \
    --resource-group MyResourceGroup \
    --name VNet1-GW-IP \
    --allocation-method Dynamic

# 3. Crea VPN Gateway (impiega 30-45 min)
az network vnet-gateway create \
    --resource-group MyResourceGroup \
    --name VNet1-GW \
    --public-ip-address VNet1-GW-IP \
    --vnet VNet1 \
    --gateway-type Vpn \
    --vpn-type RouteBased \
    --sku VpnGw1 \
    --no-wait

# 4. Crea Local Network Gateway (rappresenta on-premise)
az network local-gateway create \
    --resource-group MyResourceGroup \
    --name LocalSite \
    --gateway-ip-address 203.0.113.100 \
    --local-address-prefixes 192.168.0.0/16

# 5. Crea VPN Connection
az network vpn-connection create \
    --resource-group MyResourceGroup \
    --name VNet1-to-OnPrem \
    --vnet-gateway1 VNet1-GW \
    --local-gateway2 LocalSite \
    --location eastus \
    --shared-key "MySharedKey123"
```

**SKU disponibili**:
| SKU       | Throughput | Tunnel S2S | Tunnel P2S | BGP |
|-----------|------------|------------|------------|-----|
| Basic     | 100 Mbps   | 10         | 128        | No  |
| VpnGw1    | 650 Mbps   | 30         | 250        | Yes |
| VpnGw2    | 1 Gbps     | 30         | 500        | Yes |
| VpnGw3    | 1.25 Gbps  | 30         | 1000       | Yes |
| VpnGw4    | 5 Gbps     | 100        | 5000       | Yes |
| VpnGw5    | 10 Gbps    | 100        | 10000      | Yes |

### 11.2.2 Azure Point-to-Site VPN

Per client individuali (Windows, macOS, Linux, mobile).

**Protocolli supportati**:
- **OpenVPN** (SSL/TLS)
- **IKEv2** (nativo Windows/iOS)
- **SSTP** (solo Windows)

**Configurazione P2S**:

```bash
# 1. Genera certificati per autenticazione
# Root certificate
openssl req -x509 -nodes -days 3650 -newkey rsa:2048 \
    -keyout rootCert.key -out rootCert.crt \
    -subj "/C=IT/ST=Lombardia/L=Milano/O=Company/CN=VPN Root CA"

# Client certificates (derivato da root)
openssl genrsa -out client1.key 2048
openssl req -new -key client1.key -out client1.csr \
    -subj "/C=IT/O=Company/CN=client1"
openssl x509 -req -in client1.csr -CA rootCert.crt -CAkey rootCert.key \
    -CAcreateserial -out client1.crt -days 365

# 2. Upload root certificate ad Azure
az network vnet-gateway root-cert create \
    --resource-group MyResourceGroup \
    --gateway-name VNet1-GW \
    --name RootCert \
    --public-cert-data "$(cat rootCert.crt | base64 -w 0)"

# 3. Configura P2S
az network vnet-gateway update \
    --resource-group MyResourceGroup \
    --name VNet1-GW \
    --address-prefixes 172.16.0.0/24 \
    --client-protocol OpenVPN \
    --vpn-auth-type Certificate

# 4. Download VPN client package
az network vnet-gateway vpn-client generate \
    --resource-group MyResourceGroup \
    --name VNet1-GW \
    --processor-architecture Amd64

# Output: URL to download ZIP with client configs
```

### 11.2.3 Azure Virtual WAN

Soluzione hub-and-spoke per connettività globale:

```
                  Virtual WAN Hub
                  (Global Transit)
                        |
        +---------------+--------------+
        |               |              |
     Branch 1        Branch 2      VNet (Azure)
   (VPN S2S)      (ExpressRoute)   10.1.0.0/16
  192.168.1.0/24   192.168.2.0/24
```

**Vantaggi**:
- Routing transitivo automatico
- Multi-region support
- SD-WAN integration
- Gestione centralizzata

## 11.3 Google Cloud VPN

### 11.3.1 Classic VPN

```bash
# gcloud - Creare Classic VPN

# 1. Crea VPN Gateway
gcloud compute target-vpn-gateways create vpn-gateway-1 \
    --network default \
    --region us-central1

# 2. Reserve static IP
gcloud compute addresses create vpn-static-ip \
    --region us-central1

# 3. Forwarding rules (ESP, UDP 500, UDP 4500)
gcloud compute forwarding-rules create vpn-rule-esp \
    --region us-central1 \
    --ip-protocol ESP \
    --address vpn-static-ip \
    --target-vpn-gateway vpn-gateway-1

gcloud compute forwarding-rules create vpn-rule-udp500 \
    --region us-central1 \
    --ip-protocol UDP \
    --ports 500 \
    --address vpn-static-ip \
    --target-vpn-gateway vpn-gateway-1

gcloud compute forwarding-rules create vpn-rule-udp4500 \
    --region us-central1 \
    --ip-protocol UDP \
    --ports 4500 \
    --address vpn-static-ip \
    --target-vpn-gateway vpn-gateway-1

# 4. Crea VPN tunnel
gcloud compute vpn-tunnels create tunnel-to-onprem \
    --peer-address 203.0.113.100 \
    --region us-central1 \
    --ike-version 2 \
    --shared-secret MySharedSecret123 \
    --target-vpn-gateway vpn-gateway-1 \
    --local-traffic-selector 10.128.0.0/20 \
    --remote-traffic-selector 192.168.0.0/16

# 5. Crea route
gcloud compute routes create route-to-onprem \
    --network default \
    --next-hop-vpn-tunnel tunnel-to-onprem \
    --next-hop-vpn-tunnel-region us-central1 \
    --destination-range 192.168.0.0/16
```

### 11.3.2 HA VPN (High Availability)

Configurazione ridondante con 2 interfacce e 4 tunnel:

```
On-Premise                       GCP HA VPN Gateway
                                 (2 external IPs)
Router 1 ---- Tunnel 1 ----> Interface 0 (IP1)
         \--- Tunnel 2 ----> Interface 1 (IP2)
                                      |
Router 2 ---- Tunnel 3 ----> Interface 0 (IP1)
         \--- Tunnel 4 ----> Interface 1 (IP2)
```

**99.99% SLA** se configurato correttamente.

```bash
# Crea HA VPN Gateway
gcloud compute vpn-gateways create ha-vpn-gw \
    --network default \
    --region us-central1

# HA VPN ha 2 interfacce automaticamente
# Interface 0: 35.242.x.x
# Interface 1: 35.220.y.y
```

### 11.3.3 Cloud VPN con Cloud Router (BGP)

```bash
# Crea Cloud Router per BGP
gcloud compute routers create cloud-router \
    --network default \
    --region us-central1 \
    --asn 65001

# Crea VPN tunnel con BGP
gcloud compute vpn-tunnels create ha-tunnel-1 \
    --peer-gcp-gateway ha-vpn-gw \
    --region us-central1 \
    --ike-version 2 \
    --shared-secret MySecret123 \
    --router cloud-router \
    --vpn-gateway-interface 0

# Configura BGP session
gcloud compute routers add-bgp-peer cloud-router \
    --peer-name onprem-router-1 \
    --interface if-tunnel-1 \
    --peer-ip-address 169.254.1.2 \
    --peer-asn 65000 \
    --region us-central1
```

## 11.4 Confronto tra Servizi Cloud

| Caratteristica      | AWS VPN           | Azure VPN Gateway | Google Cloud VPN |
|---------------------|-------------------|-------------------|------------------|
| **Protocollo**      | IPsec             | IPsec             | IPsec            |
| **IKE Version**     | IKEv1, IKEv2      | IKEv2             | IKEv1, IKEv2     |
| **BGP Support**     | Sì                | Sì                | Sì               |
| **Max Throughput**  | 1.25 Gbps/tunnel  | 10 Gbps (VpnGw5)  | 3 Gbps/tunnel    |
| **HA SLA**          | 99.95%            | 99.95%            | 99.99% (HA VPN)  |
| **Tunnel per GW**   | 2 (ridondanti)    | 30-100            | Illimitati       |
| **Client VPN**      | Sì (OpenVPN)      | Sì (IKEv2/OpenVPN)| No (usa Identity-Aware Proxy) |
| **Pricing Model**   | $/ora + $/GB      | $/ora + $/GB      | $/ora tunnel + $/GB |
| **Active-Active**   | Sì (con BGP)      | Sì                | Sì (HA VPN)      |

**Considerazioni per la scelta**:

1. **AWS**: Meglio per:
   - Integrazione profonda con servizi AWS (EC2, Lambda, etc.)
   - Transit Gateway per architetture multi-VPC complesse
   - Client VPN gestito con autenticazione AD/SAML

2. **Azure**: Meglio per:
   - Ambienti Microsoft-centric (AD, Office 365)
   - Throughput elevato (fino a 10 Gbps)
   - Integrazione ExpressRoute + VPN backup

3. **Google Cloud**: Meglio per:
   - HA elevata (99.99% SLA con HA VPN)
   - Integrazione con Google Workspace
   - Networking avanzato e performance globale

## 11.5 VPN Commerciali (Consumer)

### 11.5.1 Panoramica Servizi

Principali provider VPN consumer:

| Provider      | Server | Paesi | Protocolli       | No-Log | Prezzo/mese |
|---------------|--------|-------|------------------|--------|-------------|
| **NordVPN**   | 5400+  | 60    | OpenVPN, IKEv2, WG | Sì   | €3-11       |
| **ExpressVPN**| 3000+  | 94    | OpenVPN, L2TP    | Sì     | €6-12       |
| **Surfshark** | 3200+  | 65    | OpenVPN, IKEv2, WG | Sì   | €2-12       |
| **ProtonVPN** | 1700+  | 63    | OpenVPN, IKEv2, WG | Sì   | €0-24       |
| **Mullvad**   | 700+   | 38    | OpenVPN, WG      | Sì     | €5 flat     |

### 11.5.2 Caratteristiche Comuni

**Funzionalità**:
- **Kill Switch**: Blocca internet se VPN disconnette
- **Split Tunneling**: Scegli quali app usano VPN
- **Multi-hop**: Traffico attraverso server multipli
- **Obfuscation**: Nascondere traffico VPN da DPI
- **DNS privato**: Prevenire DNS leaks

**Protocolli usati**:
```
NordVPN: NordLynx (WireGuard custom)
ExpressVPN: Lightway (proprietario)
Surfshark: WireGuard
ProtonVPN: OpenVPN + WireGuard
Mullvad: WireGuard + OpenVPN
```

### 11.5.3 OpenVPN Config da Provider

Esempio configurazione NordVPN:

```bash
# Download config
wget https://downloads.nordcdn.com/configs/files/ovpn_udp/servers/it123.nordvpn.com.udp.ovpn

# File contiene:
client
dev tun
proto udp
remote it123.nordvpn.com 1194
resolv-retry infinite
nobind
persist-key
persist-tun
cipher AES-256-CBC
auth SHA512
tls-client
remote-cert-tls server
auth-user-pass  # Prompt per username/password

# Credenziali in file separato
echo "username" > /etc/openvpn/nordvpn-creds.txt
echo "password" >> /etc/openvpn/nordvpn-creds.txt
chmod 600 /etc/openvpn/nordvpn-creds.txt

# Connetti
openvpn --config it123.nordvpn.com.udp.ovpn --auth-user-pass /etc/openvpn/nordvpn-creds.txt
```

### 11.5.4 WireGuard con Mullvad

```ini
# mullvad-it-mln.conf
[Interface]
PrivateKey = YOUR_PRIVATE_KEY_HERE
Address = 10.XX.XX.XX/32
DNS = 193.138.218.74

# Kill switch (Linux)
PostUp = iptables -I OUTPUT ! -o %i -m mark ! --mark $(wg show %i fwmark) -m addrtype ! --dst-type LOCAL -j REJECT
PostDown = iptables -D OUTPUT ! -o %i -m mark ! --mark $(wg show %i fwmark) -m addrtype ! --dst-type LOCAL -j REJECT

[Peer]
PublicKey = SERVER_PUBLIC_KEY_HERE
AllowedIPs = 0.0.0.0/0, ::/0
Endpoint = it-mln-wg-001.relays.mullvad.net:51820
```

**Attivazione**:
```bash
wg-quick up mullvad-it-mln
wg show
ping -c 3 8.8.8.8
curl ifconfig.me  # Verifica IP pubblico (dovrebbe essere IP Mullvad)
```

### 11.5.5 Testing VPN Privacy

**DNS Leak Test**:
```bash
# Check DNS servers being used
nmcli dev show | grep DNS
systemd-resolve --status

# Online test
curl https://www.dnsleaktest.com/
```

**WebRTC Leak Test** (può rivelare IP reale anche con VPN):
```javascript
// In browser console
var pc = new RTCPeerConnection({iceServers:[]});
pc.createDataChannel('');
pc.createOffer(pc.setLocalDescription.bind(pc), ()=>{});
pc.onicecandidate = (ice) => {
    if (ice && ice.candidate && ice.candidate.candidate) {
        console.log(ice.candidate.candidate);
    }
};
```

**Mitigazione WebRTC leak**:
- Firefox: `media.peerconnection.enabled = false` in `about:config`
- Chrome: Estensione "WebRTC Leak Prevent"
- Brave: Shield impostato su "Aggressive"

## 11.6 Criteri di Scelta di una VPN Commerciale

### 11.6.1 Checklist Valutazione

**Sicurezza e Privacy**:
- [ ] Politica no-log verificata da audit indipendente
- [ ] Giurisdizione favorevole (fuori 5/9/14 Eyes)
- [ ] Protocolli moderni (WireGuard, IKEv2)
- [ ] Crittografia forte (AES-256, ChaCha20)
- [ ] Perfect Forward Secrecy
- [ ] Kill switch affidabile
- [ ] DNS privato/encrypted
- [ ] No IPv6/WebRTC leaks

**Performance**:
- [ ] Server in località richieste
- [ ] Throughput adeguato (test speed)
- [ ] Latenza accettabile per uso
- [ ] Unlimited bandwidth
- [ ] P2P/torrenting permesso

**Usabilità**:
- [ ] Client per tutti i dispositivi necessari
- [ ] Numero dispositivi simultanei adeguato
- [ ] Split tunneling disponibile
- [ ] Obfuscation per paesi restrittivi
- [ ] Supporto tecnico responsive

**Costo**:
- [ ] Prezzo competitivo per funzionalità
- [ ] Trial o money-back guarantee
- [ ] Metodi pagamento anonimi (crypto, cash)
- [ ] Rinnovo automatico trasparente

### 11.6.2 Test Performance

Script per testare velocità con/senza VPN:

```bash
#!/bin/bash
# vpn-speed-test.sh

echo "=== Test WITHOUT VPN ==="
speedtest-cli --simple

echo ""
echo "=== Connecting VPN ==="
wg-quick up mullvad-it

sleep 5

echo "=== Test WITH VPN ==="
speedtest-cli --simple

echo ""
echo "=== Disconnecting VPN ==="
wg-quick down mullvad-it

# Output example:
# WITHOUT VPN:
# Ping: 15.234 ms
# Download: 95.42 Mbit/s
# Upload: 18.73 Mbit/s
#
# WITH VPN:
# Ping: 28.456 ms
# Download: 82.15 Mbit/s
# Upload: 16.92 Mbit/s
```

### 11.6.3 Red Flags

**Evitare VPN che**:
- Offrono "VPN gratis" (monetizzano vendendo dati)
- Non specificano protocolli/encryption usati
- Richiedono troppe informazioni personali
- Hanno sede in paesi con leggi data retention obbligatorie
- Mancanza di trasparenza su ownership
- Performance insolitamente elevate (sospetto di under-delivering)
- Promesse irrealistiche ("anonimato totale", "100% sicuro")

**Caso Hola VPN** (esempio negativo):
- "Free" VPN che vendeva bandwidth utenti come botnet
- P2P network dove il tuo IP veniva usato da altri
- Massiva violazione privacy e rischio legale

## Esercizi

1. **AWS Site-to-Site**: Configura VPN tra laboratorio on-premise simulato e AWS VPC
2. **Azure P2S**: Setup Point-to-Site VPN con autenticazione certificato
3. **GCP HA VPN**: Implementa HA VPN con 99.99% SLA e BGP routing
4. **Provider Comparison**: Test velocità e latenza di 3 VPN commerciali diverse
5. **Privacy Test**: Verifica DNS leaks, WebRTC leaks, IP leaks per un provider

## Riepilogo

- **Cloud VPN** (AWS, Azure, GCP) forniscono connettività gestita tra on-premise e cloud
- **Site-to-Site VPN** connettono reti, **Point-to-Site** connettono client individuali
- **BGP** abilita routing dinamico e failover automatico
- **HA VPN** (GCP) offre 99.99% SLA con architettura ridondante
- **VPN commerciali** offrono privacy e security per utenti finali
- **Criteri di scelta**: no-log policy, protocolli moderni, performance, giurisdizione

---

**Precedente**: [10. VPN e Networking](10.VPN_e_Networking.md)  
**Successivo**: [12. Troubleshooting e Diagnostica](12.Troubleshooting_e_Diagnostica.md)  
**Torna a**: [README](README.md)

# 12. Troubleshooting e Diagnostica VPN

## Introduzione

Il troubleshooting VPN richiede una metodologia sistematica per identificare rapidamente i problemi a livello di connettività, autenticazione, routing o performance. Questo capitolo fornisce tecniche diagnostiche, strumenti e soluzioni ai problemi più comuni.

## 12.1 Metodologia di Troubleshooting

### 12.1.1 Approccio Stratificato (OSI Model)

Troubleshooting dal basso verso l'alto:

```
Layer 7 - Application    → VPN client/software issues
Layer 6 - Presentation   → Encryption/decryption issues
Layer 5 - Session        → IKE negotiation, authentication
Layer 4 - Transport      → TCP/UDP port issues
Layer 3 - Network        → Routing, IP addressing, IPsec
Layer 2 - Data Link      → VLAN, switch config
Layer 1 - Physical       → Cable, fiber, link status
```

**Workflow sistematico**:
1. **Verifica fisica**: Link up? Cable connesso?
2. **Verifica IP**: IP assegnato? Gateway raggiungibile?
3. **Verifica connettività**: Ping gateway? Ping VPN server?
4. **Verifica porte**: Firewall blocca? Port scanning
5. **Verifica autenticazione**: Credenziali corrette? Certificati validi?
6. **Verifica tunneling**: Tunnel stabilito? Traffico passa?
7. **Verifica routing**: Route corrette? MTU issues?
8. **Verifica performance**: Latency? Packet loss?

### 12.1.2 Raccolta Informazioni Iniziale

**Domande chiave**:
- È mai funzionato prima? (nuova installazione vs regressione)
- Quando è iniziato il problema?
- Cosa è cambiato recentemente? (config, firmware, firewall)
- Il problema è costante o intermittente?
- Quanti utenti sono affetti? (1 vs tutti)
- Quale protocollo VPN? (IPsec, OpenVPN, WireGuard)

**Dati da raccogliere**:
```bash
# Network info
ip addr show
ip route show
cat /etc/resolv.conf

# VPN service status
systemctl status openvpn-server@server
systemctl status strongswan

# Firewall rules
iptables -L -v -n
ufw status verbose

# Logs
journalctl -u openvpn-server@server -n 100
tail -100 /var/log/syslog | grep -i vpn
```

## 12.2 Problemi Comuni e Soluzioni

### 12.2.1 Tunnel non si stabilisce

#### Problema: IPsec Fase 1 fallisce (IKE)

**Sintomi**:
```
No proposal chosen
No suitable transform found
Authentication failed
```

**Diagnosi**:
```bash
# Verifica logs strongSwan
journalctl -u strongswan -f

# Common errors:
# "no proposal chosen" → cipher mismatch
# "received AUTHENTICATION_FAILED" → wrong PSK/cert
# "peer not responding" → firewall/routing issue
```

**Soluzioni**:

1. **Cipher mismatch**: Allinea algoritmi su entrambi i lati
```bash
# Lato A
ike=aes256-sha2_256-modp2048!

# Lato B (DEVE matchare)
ike=aes256-sha2_256-modp2048!
```

2. **PSK mismatch**: Verifica pre-shared key
```bash
# /etc/ipsec.secrets
# Assicurati che PSK sia IDENTICO su entrambi i peer
203.0.113.100 198.51.100.50 : PSK "ExactlyTheSameSecret123"
```

3. **Certificate issues**: Verifica validità
```bash
# Check certificate
openssl x509 -in server.crt -text -noout | grep -E "Not Before|Not After"

# Verify certificate chain
openssl verify -CAfile ca.crt server.crt

# Check certificate revocation
openssl crl -in crl.pem -noout -text
```

#### Problema: IPsec Fase 2 fallisce (Child SA)

**Sintomi**:
```
TS unacceptable
Traffic selector mismatch
Child SA failed to establish
```

**Causa**: Subnet mismatch nei traffic selectors.

**Soluzione**:
```bash
# Verifica traffic selectors configurati
ipsec statusall

# Lato Site A
leftsubnet=192.168.1.0/24
rightsubnet=192.168.10.0/24

# Lato Site B (INVERSO!)
leftsubnet=192.168.10.0/24
rightsubnet=192.168.1.0/24
```

#### Problema: OpenVPN - Connection refused

**Sintomi**:
```
Connection refused
TCP connection failed
UDP timeout
```

**Diagnosi**:
```bash
# Test connectivity to server
telnet vpn.example.com 1194
nc -vz vpn.example.com 1194 -u  # UDP

# Check if server is listening
ss -tuln | grep 1194
netstat -tuln | grep 1194

# Test from external network
nmap -p 1194 -sU vpn.example.com
```

**Soluzioni**:

1. **Service not running**:
```bash
systemctl status openvpn-server@server
systemctl start openvpn-server@server
systemctl enable openvpn-server@server
```

2. **Firewall blocking**:
```bash
# Check iptables
iptables -L INPUT -v -n | grep 1194

# Add rule
iptables -I INPUT -p udp --dport 1194 -j ACCEPT
iptables-save > /etc/iptables/rules.v4

# UFW
ufw allow 1194/udp
ufw reload
```

3. **Port forwarding non configurato** (se server dietro NAT):
```bash
# Configura router per forward 1194/UDP → internal IP server
# Verifica con port checker esterno
```

### 12.2.2 Tunnel si stabilisce ma nessun traffico

#### Problema: Routing non configurato

**Sintomi**: Tunnel UP ma ping non funziona.

**Diagnosi**:
```bash
# Verifica tunnel interface
ip addr show tun0

# Verifica routing
ip route show
# Dovrebbe esserci route verso subnet remota via tun0

# Test ping attraverso tunnel
ping -I tun0 192.168.10.1
```

**Soluzioni**:

1. **Aggiungi route mancante**:
```bash
# Client side (OpenVPN)
# In /etc/openvpn/client.conf
route 192.168.10.0 255.255.255.0

# Server side - push route
push "route 192.168.1.0 255.255.255.0"

# IPsec - automatico se rightsubnet configurato
```

2. **IP forwarding non abilitato** (su gateway):
```bash
# Check
sysctl net.ipv4.ip_forward
# Deve essere = 1

# Enable
echo 1 > /proc/sys/net/ipv4/ip_forward
# Permanent
echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
sysctl -p
```

3. **Firewall blocca forwarding**:
```bash
# Check FORWARD chain
iptables -L FORWARD -v -n

# Allow forwarding VPN → LAN
iptables -A FORWARD -i tun0 -o eth1 -j ACCEPT
iptables -A FORWARD -i eth1 -o tun0 -m state --state RELATED,ESTABLISHED -j ACCEPT

# NAT se necessario
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
```

#### Problema: Traffico unidirezionale

**Sintomi**: Ping da A → B funziona, ma B → A no.

**Causa**: Routing asimmetrico o firewall.

**Diagnosi**:
```bash
# Da Site B, traceroute verso A
traceroute -I 192.168.1.10

# Verifica iptables FORWARD su entrambi i lati
iptables -L FORWARD -v -n
```

**Soluzione**:
```bash
# Assicurati che FORWARD permetta traffico bidirezionale
# Site A
iptables -A FORWARD -i tun0 -j ACCEPT
iptables -A FORWARD -o tun0 -j ACCEPT

# Site B (same)
iptables -A FORWARD -i tun0 -j ACCEPT
iptables -A FORWARD -o tun0 -j ACCEPT
```

### 12.2.3 Autenticazione Fallisce

#### Problema: Certificate verification failed

**Sintomi**:
```
VERIFY ERROR: depth=0, error=certificate has expired
VERIFY ERROR: unable to get issuer certificate
```

**Diagnosi**:
```bash
# Check certificate expiry
openssl x509 -in client.crt -noout -dates
# Not Before: Jan  1 00:00:00 2023 GMT
# Not After : Dec 31 23:59:59 2025 GMT  ← EXPIRED!

# Check CA
openssl verify -CAfile ca.crt client.crt
# Se fallisce, problema con chain of trust
```

**Soluzioni**:

1. **Rinnova certificato scaduto**:
```bash
# Easy-RSA
cd /etc/openvpn/easy-rsa/
./easyrsa renew client1 nopass

# Distribuisci nuovo client.crt al client
```

2. **Problemi chain of trust**:
```bash
# Verifica che client abbia ca.crt corretto
# Su client
md5sum ca.crt
# Su server
md5sum ca.crt
# MD5 deve matchare!
```

3. **Time sync issues**:
```bash
# Certificati hanno validità basata su tempo
# Se clock è sbagliato, cert può sembrare scaduto

# Check time
date
timedatectl

# Sync time
ntpdate pool.ntp.org
# oppure
systemctl restart systemd-timesyncd
```

#### Problema: RADIUS authentication timeout

**Sintomi**:
```
RADIUS server not responding
Authentication timeout
```

**Diagnosi**:
```bash
# Test RADIUS connectivity
radtest username password radius-server-ip 1812 shared-secret

# Check RADIUS server logs
tail -f /var/log/freeradius/radius.log

# Verifica firewall
nmap -p 1812,1813 radius-server-ip
```

**Soluzioni**:
```bash
# Verifica shared secret in strongSwan e RADIUS siano identici
# /etc/strongswan.d/charon/eap-radius.conf
servers {
    primary {
        address = 192.168.1.100
        secret = SharedSecret123  ← Must match RADIUS config
    }
}

# Firewall - allow RADIUS
iptables -A INPUT -p udp --dport 1812 -s VPN_GATEWAY_IP -j ACCEPT
iptables -A INPUT -p udp --dport 1813 -s VPN_GATEWAY_IP -j ACCEPT
```

### 12.2.4 Performance Issues

#### Problema: Throughput basso

**Diagnosi**:
```bash
# Baseline test senza VPN
iperf3 -c server-ip

# Test con VPN attiva
iperf3 -c remote-via-vpn-ip

# Check CPU usage
top
# Se processo VPN (openvpn/charon) al 100%, CPU è bottleneck
```

**Soluzioni**:

1. **Cipher optimization**:
```bash
# OpenVPN - usa cipher hardware-accelerated
cipher AES-256-GCM  # Più veloce di AES-256-CBC con AES-NI

# IPsec
esp=aes256gcm16!  # GCM mode è più veloce

# WireGuard - già ottimizzato (ChaCha20)
```

2. **Buffer tuning**:
```bash
# OpenVPN
sndbuf 393216  # 384KB
rcvbuf 393216
push "sndbuf 393216"
push "rcvbuf 393216"

# System-wide
sysctl -w net.core.rmem_max=134217728
sysctl -w net.core.wmem_max=134217728
```

3. **Hardware acceleration**:
```bash
# Verifica AES-NI support
grep -o 'aes' /proc/cpuinfo
# Se presente, OpenSSL lo userà automaticamente

# strongSwan - verifica plugins
ipsec listplugins | grep aesni
```

#### Problema: Alta latenza

**Diagnosi**:
```bash
# Ping baseline (senza VPN)
ping -c 10 remote-ip

# Ping attraverso VPN
ping -c 10 -I tun0 remote-internal-ip

# MTR per vedere hop
mtr -r -c 10 remote-ip
```

**Soluzioni**:

1. **MTU issues** (vedere sezione 12.2.5)

2. **Server overload**:
```bash
# Check load average
uptime

# Check CPU/memory
htop

# Check network stats
sar -n DEV 1 10

# Soluzione: Scale up (più CPU/RAM) o scale out (load balancing)
```

3. **Routing subottimale**:
```bash
# Verifica path con traceroute
traceroute -I remote-ip

# Se troppi hop o percorso inefficiente
# Considera: Direct peering, BGP optimization, diverso ISP
```

### 12.2.5 MTU e Frammentazione

#### Problema: Alcuni siti/servizi non funzionano

**Sintomi**:
- HTTP/HTTPS timeout su alcuni siti
- SSH connection hangs dopo login
- File transfer si blocca
- Piccoli pacchetti OK, grandi NO

**Causa**: MTU troppo grande per tunnel VPN causa frammentazione problematica.

**Diagnosi**:
```bash
# Test MTU size
# Linux
ping -M do -s 1472 remote-ip  # 1472 + 28 (headers) = 1500
# Se fallisce, riduci size fino a trovare MTU ottimale

# Windows
ping -f -l 1472 remote-ip

# Path MTU Discovery
tracepath remote-ip
# Output mostra MTU di ogni hop
```

**Soluzioni**:

1. **Ridurre MTU su tunnel**:
```bash
# OpenVPN
mssfix 1400  # Clamps TCP MSS
tun-mtu 1400

# Linux interface
ip link set tun0 mtu 1400

# Permanent (Debian/Ubuntu)
echo "link-mtu 1400" >> /etc/openvpn/server.conf
```

2. **MSS Clamping con iptables**:
```bash
# Forza TCP MSS a 1360 per evitare frammentazione
iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1360

# Specifico per interfaccia VPN
iptables -t mangle -A FORWARD -o tun0 -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1360
```

3. **PMTUD (Path MTU Discovery)**:
```bash
# Verifica se PMTUD funziona
sysctl net.ipv4.ip_no_pmtu_disc
# Dovrebbe essere 0 (PMTUD enabled)

# Alcuni firewall bloccano ICMP Fragmentation Needed
# Soluzione: Whitelist ICMP type 3 code 4
iptables -A INPUT -p icmp --icmp-type fragmentation-needed -j ACCEPT
```

**Calcolo MTU ottimale**:
```
Physical Interface MTU: 1500
- IP header: 20
- UDP header (OpenVPN): 8
- OpenVPN overhead: ~24
= Available: 1448

Quindi: tun-mtu 1400 è sicuro
MSS = MTU - 40 (TCP+IP headers) = 1360
```

### 12.2.6 DNS Issues

#### Problema: DNS resolution non funziona su VPN

**Sintomi**:
- Ping IP funziona, ping hostname no
- `nslookup google.com` timeout

**Diagnosi**:
```bash
# Check DNS config
cat /etc/resolv.conf
# Dovrebbe avere DNS interno se pushed da VPN

# Test DNS manually
dig @8.8.8.8 google.com
dig @192.168.1.10 internal.company.local  # Internal DNS

# Check if DNS pushed by VPN
# OpenVPN client log
grep -i "dhcp-option DNS" /var/log/openvpn/client.log
```

**Soluzioni**:

1. **OpenVPN - push DNS**:
```bash
# Server config
push "dhcp-option DNS 192.168.1.10"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DOMAIN company.local"

# Client - update resolv.conf script
script-security 2
up /etc/openvpn/update-resolv-conf
down /etc/openvpn/update-resolv-conf
```

2. **systemd-resolved conflicts**:
```bash
# systemd-resolved può ignorare DHCP options
# Soluzione: Configure OpenVPN to update systemd-resolved

# /etc/openvpn/update-systemd-resolved
#!/bin/bash
systemd-resolve --interface $dev --set-dns $foreign_option_1 --set-domain $foreign_option_2

# In client.conf
script-security 2
up /etc/openvpn/update-systemd-resolved
down /etc/openvpn/update-systemd-resolved
```

3. **DNS leak prevention**:
```bash
# Block DNS queries outside VPN
iptables -A OUTPUT -p udp --dport 53 -j DROP
iptables -I OUTPUT -o tun0 -p udp --dport 53 -j ACCEPT
iptables -I OUTPUT -d 192.168.1.10 -p udp --dport 53 -j ACCEPT  # Internal DNS
```

### 12.2.7 NAT-T Problems

#### Problema: IPsec non funziona dietro NAT

**Sintomi**:
- Fase 1 OK, Fase 2 fallisce
- Tunnel si disconnette dopo pochi minuti

**Diagnosi**:
```bash
# Check se NAT rilevato
ipsec statusall | grep NAT
# Should show "NAT detected: yes"

# Verifica ESP/UDP encapsulation
tcpdump -i eth0 -n 'udp port 4500'
# Dovrebbe vedere traffico se NAT-T attivo
```

**Soluzioni**:

1. **Enable NAT-T explicitly**:
```bash
# strongSwan /etc/ipsec.conf
conn myconn
    forceencaps=yes  # Force UDP encapsulation anche se no NAT

# Keep-alive per NAT mapping
    dpddelay=10s
    dpdtimeout=30s
```

2. **NAT gateway configuration**:
```bash
# Router NAT deve permettere:
# - UDP 500 (IKE)
# - UDP 4500 (NAT-T)
# - IP Protocol 50 (ESP) - se no NAT-T

# Port forwarding se client VPN dietro NAT
# Forward UDP 500, 4500 → client internal IP
```

## 12.3 Strumenti Diagnostici

### 12.3.1 tcpdump

Cattura pacchetti per analisi dettagliata.

**Esempi pratici**:

```bash
# Cattura traffico VPN su porta 1194 (OpenVPN)
tcpdump -i eth0 -n udp port 1194 -w openvpn-capture.pcap

# IPsec - cattura IKE e ESP
tcpdump -i eth0 -n '(udp port 500) or (udp port 4500) or (ip proto 50)'

# Traffico sul tunnel
tcpdump -i tun0 -n

# Filtra per host specifico
tcpdump -i tun0 -n host 192.168.10.5

# Verbose con headers
tcpdump -i eth0 -n -vv udp port 1194

# Real-time monitoring
tcpdump -i eth0 -n -l udp port 1194 | grep -E 'Flags|length'
```

### 12.3.2 Wireshark

GUI per analisi avanzata dei pacchetti.

**Workflow**:
1. Cattura con tcpdump e salva `.pcap`
2. Apri in Wireshark
3. Usa filtri display:
   ```
   # OpenVPN
   udp.port == 1194
   
   # IPsec IKE
   isakmp
   
   # ESP
   esp
   
   # Specifico IP
   ip.addr == 10.8.0.5
   ```

**Features utili**:
- **Follow TCP/UDP Stream**: Vedi conversazione completa
- **Statistics → Conversations**: Vedi quali host parlano tra loro
- **Statistics → IO Graph**: Visualizza throughput nel tempo
- **Expert Info**: Rileva anomalie automaticamente

### 12.3.3 ipsec Commands

```bash
# Status generale
ipsec status

# Status dettagliato
ipsec statusall

# Informazioni su connection specifica
ipsec status myconnection

# List installed SAs (Security Associations)
ip xfrm state

# List installed policies
ip xfrm policy

# Restart connection
ipsec down myconnection
ipsec up myconnection

# Force rekey
ipsec rekey myconnection

# Show loaded plugins
ipsec listplugins

# Show algorithms supportati
ipsec listalgs
```

### 12.3.4 OpenVPN Management Interface

```bash
# Abilitato in server.conf
management localhost 7505

# Connetti via telnet
telnet localhost 7505

# Commands disponibili:
> status         # Mostra client connessi
> kill client1   # Disconnetti client
> log            # Real-time logs
> signal SIGUSR1 # Reload config
> exit
```

**Script per monitoring**:
```bash
#!/bin/bash
# openvpn-monitor.sh
echo "status" | nc localhost 7505 | grep "CLIENT_LIST" | awk -F',' '{print $2, $4, $5}'
# Output: username, bytesRX, bytesTX
```

### 12.3.5 MTR (My TraceRoute)

Combinazione di ping + traceroute con statistiche.

```bash
# Basic
mtr remote-host

# Report mode (10 cicli)
mtr -r -c 10 remote-host

# Specify interface
mtr -I tun0 remote-host

# Output formato CSV per parsing
mtr --csv -c 100 remote-host > mtr-report.csv
```

**Interpretazione**:
- **Loss%**: Packet loss per hop
- **Last, Avg, Best, Wrst**: Latency (ms)
- **StDev**: Deviazione standard (jitter)

Se vedi loss intermedio ma 0% alla fine → probabilemi ICMP rate limiting, non reale loss.

### 12.3.6 ss / netstat

Verifica connessioni e porte listening.

```bash
# Show listening UDP ports (OpenVPN, IPsec)
ss -tuln

# Show established VPN connections
ss -tun | grep 1194

# Mostra processi
ss -tulnp

# Solo OpenVPN
ss -tulnp | grep openvpn

# Statistics
ss -s
```

### 12.3.7 ip Commands

```bash
# Show all interfaces
ip addr show
ip link show

# Show routing table
ip route show

# Show routing per specific destination
ip route get 192.168.10.5

# Show policy routing
ip rule show

# Show xfrm (IPsec) state and policy
ip xfrm state
ip xfrm policy

# Add temporary route for testing
ip route add 192.168.10.0/24 via 10.8.0.1 dev tun0

# Change interface MTU
ip link set tun0 mtu 1400

# Stats per interface
ip -s link show tun0
```

## 12.4 Log Analysis

### 12.4.1 OpenVPN Logs

**Location**:
- System logs: `/var/log/syslog` o `/var/log/messages`
- OpenVPN specific: `/var/log/openvpn/openvpn.log` (se configurato)
- Status: `/var/log/openvpn/openvpn-status.log`

**Analisi errori comuni**:

```bash
# Authentication failures
grep "AUTH" /var/log/openvpn/openvpn.log

# TLS errors
grep "TLS" /var/log/openvpn/openvpn.log

# Connection attempts
grep "Peer Connection Initiated" /var/log/openvpn/openvpn.log

# Disconnections
grep "Connection reset" /var/log/openvpn/openvpn.log

# Certificate issues
grep -E "VERIFY ERROR|certificate" /var/log/openvpn/openvpn.log
```

**Pattern recognition**:
```bash
# Count auth failures per IP
grep "AUTH_FAILED" /var/log/openvpn/openvpn.log | awk '{print $NF}' | sort | uniq -c | sort -rn

# Connection duration analysis
grep -E "Peer Connection Initiated|Connection reset" /var/log/openvpn/openvpn.log
```

### 12.4.2 strongSwan/IPsec Logs

```bash
# Real-time logs
journalctl -u strongswan -f

# Last 100 lines
journalctl -u strongswan -n 100

# Since specific time
journalctl -u strongswan --since "1 hour ago"

# Filter by severity
journalctl -u strongswan -p err

# Common errors
journalctl -u strongswan | grep -E "failed|error|timeout"

# IKE negotiations
journalctl -u strongswan | grep "IKE_SA"

# Child SA establishment
journalctl -u strongswan | grep "CHILD_SA"
```

### 12.4.3 Automated Monitoring Script

```bash
#!/bin/bash
# vpn-health-check.sh

VPN_TYPE="openvpn"  # or "strongswan"
ALERT_EMAIL="admin@company.com"

check_openvpn() {
    if ! systemctl is-active --quiet openvpn-server@server; then
        echo "OpenVPN service is DOWN" | mail -s "ALERT: VPN Down" $ALERT_EMAIL
        return 1
    fi
    
    # Check connected clients
    clients=$(echo "status" | nc localhost 7505 | grep -c "CLIENT_LIST")
    echo "Connected clients: $clients"
    
    # Check tunnel interface
    if ! ip link show tun0 &>/dev/null; then
        echo "Tunnel interface tun0 DOWN" | mail -s "ALERT: Tunnel Down" $ALERT_EMAIL
        return 1
    fi
    
    return 0
}

check_ipsec() {
    if ! systemctl is-active --quiet strongswan; then
        echo "strongSwan service is DOWN" | mail -s "ALERT: IPsec Down" $ALERT_EMAIL
        return 1
    fi
    
    # Check established tunnels
    tunnels=$(ipsec status | grep -c "ESTABLISHED")
    echo "Established tunnels: $tunnels"
    
    if [ $tunnels -eq 0 ]; then
        echo "No IPsec tunnels established" | mail -s "ALERT: No Tunnels" $ALERT_EMAIL
        return 1
    fi
    
    return 0
}

# Main
if [ "$VPN_TYPE" == "openvpn" ]; then
    check_openvpn
elif [ "$VPN_TYPE" == "strongswan" ]; then
    check_ipsec
fi

# Cron job: */5 * * * * /opt/vpn-health-check.sh
```

## 12.5 Troubleshooting Checklist

### Pre-Deployment Testing

- [ ] Verify certificates/keys validity
- [ ] Test cipher compatibility
- [ ] Confirm firewall rules allow VPN ports
- [ ] Verify IP forwarding enabled
- [ ] Test basic IP connectivity (ping)
- [ ] Verify NAT/routing configuration
- [ ] Test DNS resolution
- [ ] Benchmark baseline performance (without VPN)
- [ ] Document configuration for both sides

### Active Troubleshooting

- [ ] Check service status (`systemctl status`)
- [ ] Review recent logs (`journalctl`, log files)
- [ ] Verify listening ports (`ss -tuln`)
- [ ] Test port connectivity (`telnet`, `nc`)
- [ ] Check firewall rules (`iptables -L -v -n`)
- [ ] Verify routing (`ip route`, `ip xfrm policy`)
- [ ] Test DNS (`dig`, `nslookup`)
- [ ] Check MTU (`ping -M do -s 1472`)
- [ ] Analyze packets (`tcpdump`, Wireshark)
- [ ] Monitor resources (CPU, memory, bandwidth)

### Post-Resolution

- [ ] Document root cause
- [ ] Implement permanent fix
- [ ] Update monitoring/alerts
- [ ] Review prevention measures
- [ ] Update documentation/runbooks

## Esercizi

1. **Simulare failure**: Configura volutamente PSK errato e troubleshoot usando logs

2. **MTU optimization**: Trova MTU ottimale per tunnel VPN con packet loss simulation

3. **Log parsing**: Scrivi script Bash per estrarre e analizzare connection statistics da logs

4. **Packet capture**: Usa tcpdump per catturare handshake IPsec e analizza in Wireshark

5. **Monitoring dashboard**: Setup Prometheus + Grafana per monitoring VPN

## Riepilogo

- **Approccio sistematico**: Troubleshoot layer per layer (OSI model)
- **Log analysis**: Prima risorsa per identificare problemi
- **tcpdump/Wireshark**: Essenziali per packet-level troubleshooting
- **MTU issues**: Causa comune di problemi apparentemente inspiegabili
- **Automation**: Script di monitoring prevengono downtime
- **Documentation**: Documenta soluzioni per future reference

---

**Precedente**: [11. VPN Cloud e Servizi Commerciali](11.VPN_Cloud_e_Servizi_Commerciali.md)  
**Successivo**: [13. Aspetti Legali e Privacy](13.Aspetti_Legali_e_Privacy.md)  
**Torna a**: [README](README.md)

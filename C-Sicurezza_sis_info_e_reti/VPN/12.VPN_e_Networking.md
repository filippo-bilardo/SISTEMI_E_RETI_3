# 10. VPN e Networking

## Introduzione

Le VPN non operano in isolamento ma devono integrarsi con l'infrastruttura di rete esistente, interagendo con NAT, firewall, routing, VLAN e sistemi di autenticazione come Active Directory. Questo capitolo esplora le sfide e le best practices per l'integrazione delle VPN nell'infrastruttura di networking aziendale.

## 10.1 VPN e NAT

### 10.1.1 Problematiche NAT con IPsec

Il NAT (Network Address Translation) può causare problemi significativi con IPsec, in particolare con il protocollo ESP:

**Problema principale**: IPsec ESP cripta l'intero pacchetto IP, inclusi i numeri di porta TCP/UDP. Il NAT non può modificare l'indirizzo IP senza invalidare i checksum crittografici.

```
Client VPN          NAT Device          VPN Server
10.0.0.5      →     203.0.113.1    →    198.51.100.10
   |                     |                    |
   | ESP packet          | ESP packet         |
   | SPI: 12345          | (can't modify)     |
   | Encrypted payload   | Conflict!          |
   |-------------------->|-------------------->
```

### 10.1.2 NAT Traversal (NAT-T)

**Soluzione**: NAT-T (RFC 3947) incapsula IPsec ESP in pacchetti UDP sulla porta 4500.

**Funzionamento**:
1. Durante IKE, client e server rilevano presenza di NAT
2. Se rilevato NAT, passano da ESP nativo a ESP-in-UDP
3. UDP header permette al NAT di modificare porta sorgente
4. ESP payload rimane crittografato

**Configurazione strongSwan con NAT-T**:

```bash
# /etc/ipsec.conf
conn remote-access
    left=%any
    leftsubnet=0.0.0.0/0
    right=%any
    rightsubnet=10.10.0.0/16
    
    # Enable NAT-T
    forceencaps=yes
    
    # IKE settings
    ike=aes256-sha2_256-modp2048!
    esp=aes256-sha2_256!
    
    # Authentication
    leftauth=pubkey
    rightauth=pubkey
    leftcert=serverCert.pem
    rightid=%any
    
    # Keepalives per NAT
    dpdaction=clear
    dpddelay=30s
    dpdtimeout=120s
    
    auto=add
```

### 10.1.3 OpenVPN e NAT

OpenVPN usa UDP/TCP quindi attraversa NAT senza problemi:

```bash
# Server dietro NAT - Port forwarding necessario
# Router: Forward 1194/UDP → 192.168.1.10:1194

# /etc/openvpn/server/server.conf
port 1194
proto udp
dev tun

# Il server non ha bisogno di sapere del NAT
# I client si connettono all'IP pubblico del router
```

**NAT sul server VPN per accesso Internet dei client**:

```bash
#!/bin/bash
# Abilita IP forwarding
echo 1 > /proc/sys/net/ipv4/ip_forward

# NAT per traffico VPN verso Internet
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE

# Permetti forwarding da/verso VPN
iptables -A FORWARD -i tun0 -o eth0 -j ACCEPT
iptables -A FORWARD -i eth0 -o tun0 -m state --state RELATED,ESTABLISHED -j ACCEPT
```

### 10.1.4 Doppio NAT

Scenario problematico quando client e server sono entrambi dietro NAT:

```
Client NAT          Internet          Server NAT
192.168.0.100   →   NAT1    ←→    NAT2   →   192.168.1.100
                  203.0.113.5   198.51.100.10
```

**Soluzioni**:
1. **Port forwarding** su NAT2 verso server VPN
2. **UPnP/NAT-PMP** per mapping automatico porte
3. **STUN** per discovery IP pubblico
4. **Relay server** con IP pubblico
5. **Reverse connection** (client diventa server)

## 10.2 VPN e Firewall

### 10.2.1 Porte da aprire

**IPsec**:
- UDP 500 (IKE)
- UDP 4500 (IPsec NAT-T)
- IP Protocol 50 (ESP)
- IP Protocol 51 (AH) - se usato

**OpenVPN**:
- UDP 1194 (default) o porta configurata
- TCP 443 (alternativa per ambienti restrittivi)

**WireGuard**:
- UDP 51820 (default) o porta configurata

**Esempio iptables**:

```bash
#!/bin/bash
# /etc/iptables-vpn.sh

# Flush
iptables -F
iptables -X
iptables -t nat -F

# Default policies
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# Loopback
iptables -A INPUT -i lo -j ACCEPT

# Established connections
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

# SSH (management) - limita per sicurezza
iptables -A INPUT -p tcp --dport 22 -s 192.168.1.0/24 -j ACCEPT

# IPsec
iptables -A INPUT -p udp --dport 500 -j ACCEPT    # IKE
iptables -A INPUT -p udp --dport 4500 -j ACCEPT   # NAT-T
iptables -A INPUT -p esp -j ACCEPT                # ESP

# OpenVPN
iptables -A INPUT -p udp --dport 1194 -j ACCEPT

# WireGuard
iptables -A INPUT -p udp --dport 51820 -j ACCEPT

# Forwarding per VPN
iptables -A FORWARD -i tun+ -j ACCEPT
iptables -A FORWARD -o tun+ -j ACCEPT
iptables -A FORWARD -i wg+ -j ACCEPT
iptables -A FORWARD -o wg+ -j ACCEPT

# NAT per client VPN
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -s 10.99.0.0/24 -o eth0 -j MASQUERADE

# Log dropped (rate limited)
iptables -A INPUT -m limit --limit 5/min -j LOG --log-prefix "FW-DROP-INPUT: "
iptables -A FORWARD -m limit --limit 5/min -j LOG --log-prefix "FW-DROP-FORWARD: "

# Save
iptables-save > /etc/iptables/rules.v4
```

### 10.2.2 VPN in DMZ

Posizionamento corretto del VPN gateway:

```
                    Internet
                       |
                   Firewall1
                       |
         +-------------+-------------+
         |                           |
      DMZ (VPN)                  Internal LAN
    VPN Gateway                   192.168.0.0/16
   203.0.113.10                      |
         |                       Firewall2
         +---------------------------+
```

**Regole Firewall1 (perimetrale)**:
- Permetti UDP 500, 4500, ESP verso VPN Gateway
- Permetti traffico stabilito da DMZ verso Internet
- Nega tutto il resto

**Regole Firewall2 (interno)**:
- Permetti traffico autenticato VPN → Internal LAN
- Log tutti gli accessi
- ACL per limitare accesso basato su utente/gruppo

**Configurazione iptables su VPN Gateway (DMZ)**:

```bash
# Interface eth0 = verso Internet (DMZ side)
# Interface eth1 = verso Internal LAN

# Accetta VPN traffic da Internet
iptables -A INPUT -i eth0 -p udp --dport 1194 -j ACCEPT

# Forwarding da VPN clients (tun0) verso LAN (eth1)
iptables -A FORWARD -i tun0 -o eth1 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -i eth1 -o tun0 -m state --state ESTABLISHED,RELATED -j ACCEPT

# NO forwarding da DMZ verso Internal
iptables -A FORWARD -i eth0 -o eth1 -j DROP

# NO NAT - routing diretto per VPN subnet
# Internal firewall deve avere route per 10.8.0.0/24 → VPN Gateway
```

### 10.2.3 Firewall Application-Layer

Alcuni firewall ispezionano traffico VPN:

**Problemi**:
- **SSL/TLS inspection** può rompere VPN SSL
- **DPI (Deep Packet Inspection)** può bloccare protocolli non standard
- **QoS** può throttle traffico VPN

**Soluzioni**:
1. **Whitelist** IP/porte VPN
2. **Bypass inspection** per traffico VPN
3. **Certificate pinning** per prevenire MITM
4. **Protocolli obfuscation** per bypassare DPI

## 10.3 VPN e Routing

### 10.3.1 Routing Statico

Configurazione base per VPN site-to-site:

```
Site A (HQ)                         Site B (Branch)
192.168.1.0/24                      192.168.10.0/24
VPN GW: 203.0.113.100               VPN GW: 198.51.100.50
```

**Su router Site A**:

```bash
# Cisco IOS
ip route 192.168.10.0 255.255.255.0 Tunnel0

# Linux
ip route add 192.168.10.0/24 dev tun0
# oppure
route add -net 192.168.10.0/24 dev tun0
```

**Su router Site B**:

```bash
ip route add 192.168.1.0/24 dev tun0
```

**Importante**: Client interni devono avere default gateway verso VPN gateway, o route specifiche per subnet remote.

### 10.3.2 Routing Dinamico con OSPF

Per reti complesse con ridondanza:

```
         Internet
             |
    +--------+--------+
    |                 |
  Site A            Site B
VPN1: 10.0.1.1    VPN1: 10.0.2.1
VPN2: 10.0.1.2    VPN2: 10.0.2.2
```

**Configurazione OSPF su OpenVPN (Linux + Quagga/FRR)**:

```bash
# /etc/openvpn/server.conf
# Abilita routing dinamico
client-to-client
topology subnet

# /etc/frr/ospfd.conf
router ospf
 ospf router-id 10.0.1.1
 network 10.8.0.0/24 area 0         # VPN network
 network 192.168.1.0/24 area 0      # LAN network
 
interface tun0
 ip ospf cost 10
 ip ospf hello-interval 10
 ip ospf dead-interval 40
```

**Vantaggi OSPF su VPN**:
- Failover automatico tra tunnel ridondanti
- Load balancing
- Convergenza rapida
- Scalabilità per reti grandi

### 10.3.3 BGP per VPN Cloud

In ambienti cloud o con più ISP:

```bash
# /etc/frr/bgpd.conf
router bgp 65001
 bgp router-id 10.0.1.1
 
 # Neighbor AWS VPN
 neighbor 169.254.10.1 remote-as 65000
 neighbor 169.254.10.1 timers 10 30
 
 # Announce local networks
 network 192.168.1.0/24
 
 # Prefer path con AS-PATH più corto
 bgp bestpath as-path multipath-relax
```

### 10.3.4 Policy-Based Routing (PBR)

Instradare traffico VPN basandosi su criteri specifici:

```bash
# Linux ip rule / ip route
# Traffico da 192.168.1.0/24 verso Internet via VPN

# Crea routing table custom
echo "200 vpn_table" >> /etc/iproute2/rt_tables

# Aggiungi default route via VPN in custom table
ip route add default dev tun0 table vpn_table

# Policy: traffico da LAN usa VPN table
ip rule add from 192.168.1.0/24 table vpn_table

# Traffico management (SSH) usa routing normale
ip rule add from 192.168.1.10 table main priority 100
```

## 10.4 VPN e VLAN

### 10.4.1 Segmentazione con VLAN

Isolare traffico VPN per reparto/sicurezza:

```
VPN Users
    |
VPN Gateway
    |
  Trunk
    |
Switch (VLAN-aware)
    |
+---+---+---+
|   |   |   |
V10 V20 V30 V99
IT  HR  Fin Mgmt
```

**Configurazione OpenVPN con VLAN assignment dinamico**:

```bash
# /etc/openvpn/server.conf
client-config-dir /etc/openvpn/ccd
script-security 2
learn-address /etc/openvpn/scripts/learn-address.sh

# /etc/openvpn/ccd/user-it
# Assegna IP statico e route verso VLAN IT
ifconfig-push 10.8.0.10 255.255.255.0
push "route 192.168.10.0 255.255.255.0"

# /etc/openvpn/ccd/user-hr
ifconfig-push 10.8.0.20 255.255.255.0
push "route 192.168.20.0 255.255.255.0"
```

**Firewall per VLAN isolation**:

```bash
# Solo VLAN 10 può accedere VLAN 99 (management)
iptables -A FORWARD -s 10.8.0.10/32 -d 192.168.99.0/24 -j ACCEPT
iptables -A FORWARD -s 10.8.0.0/24 -d 192.168.99.0/24 -j DROP

# VLAN 20 (HR) isolata da altre VLAN
iptables -A FORWARD -s 10.8.0.20/32 -d 192.168.10.0/24 -j DROP
```

### 10.4.2 VLAN Tagging su VPN

Per estendere VLAN attraverso VPN:

**802.1Q tunneling (Q-in-Q)**:

```bash
# Linux bridge + VLAN tags
# Crea bridge per ogni VLAN
ip link add br10 type bridge vlan_filtering 1
ip link set br10 up

# Aggiungi tun0 e eth0.10 al bridge
ip link add link eth0 name eth0.10 type vlan id 10
ip link set eth0.10 master br10
ip link set tun0 master br10

# Ora VLAN 10 è estesa attraverso VPN
```

## 10.5 Integrazione con Active Directory

### 10.5.1 Autenticazione LDAP/AD

**OpenVPN con plugin auth-pam**:

```bash
# Installazione
apt-get install openvpn-auth-ldap

# /etc/openvpn/auth-ldap.conf
<LDAP>
    URL             ldap://dc.company.local
    BindDN          "cn=vpnauth,ou=Service Accounts,dc=company,dc=local"
    Password        "SecurePassword123"
    Timeout         15
    TLSEnable       yes
    FollowReferrals yes
</LDAP>

<Authorization>
    BaseDN          "ou=Users,dc=company,dc=local"
    SearchFilter    "(&(objectClass=user)(sAMAccountName=%u))"
    RequireGroup    false
    
    <Group>
        BaseDN          "ou=Groups,dc=company,dc=local"
        SearchFilter    "(cn=VPN-Users)"
        MemberAttribute member
    </Group>
</Authorization>

# /etc/openvpn/server.conf
plugin /usr/lib/openvpn/openvpn-auth-ldap.so /etc/openvpn/auth-ldap.conf
client-cert-not-required  # Solo user/pass
username-as-common-name
```

### 10.5.2 RADIUS con NPS (Windows)

**Configurazione strongSwan con RADIUS**:

```bash
# /etc/strongswan.d/charon/eap-radius.conf
eap-radius {
    accounting = yes
    servers {
        primary {
            address = 192.168.1.100
            secret = SharedSecret123
            auth_port = 1812
            acct_port = 1813
        }
        secondary {
            address = 192.168.1.101
            secret = SharedSecret123
        }
    }
}

# /etc/ipsec.conf
conn remote-access-radius
    right=%any
    rightsourceip=10.10.0.0/24
    
    # EAP authentication
    eap_identity=%identity
    rightauth=eap-radius
    rightauth2=eap-mschapv2
    
    leftauth=pubkey
    leftcert=serverCert.pem
    
    auto=add
```

**Windows NPS setup**:
1. Installa ruolo **Network Policy Server**
2. Registra NPS in Active Directory
3. Crea **RADIUS Client** (IP del VPN gateway)
4. Crea **Network Policy**:
   - Condizioni: NAS Port Type = Virtual (VPN)
   - Condizioni: Windows Groups = "CN=VPN-Users,OU=Groups,DC=company,DC=local"
   - Constraints: Authentication Methods = MS-CHAPv2
   - Settings: IP Filters, Routes da assegnare

### 10.5.3 Group Policy via VPN

Applicare GPO a client VPN come se fossero in LAN:

```
Client VPN → Tunnel → Domain Controller
                         |
                    GPO Application
```

**Requisiti**:
1. Client deve risolvere nome dominio interno
2. Connettività verso DC (TCP 389 LDAP, 88 Kerberos, 445 SMB)
3. DNS configurato per risolvere AD domain

**OpenVPN push DNS**:

```bash
# /etc/openvpn/server.conf
push "dhcp-option DNS 192.168.1.10"       # DC IP
push "dhcp-option DNS 192.168.1.11"       # Backup DC
push "dhcp-option DOMAIN company.local"
push "dhcp-option DOMAIN-SEARCH company.local"

# Push route verso DC subnet
push "route 192.168.1.0 255.255.255.0"
```

**Verifica GPO apply su client Windows VPN**:

```powershell
# Forza refresh GPO
gpupdate /force

# Verifica GPO applicati
gpresult /r
gpresult /h report.html

# Verifica connettività DC
Test-ComputerSecureChannel -Verbose
nltest /dsgetsite
```

### 10.5.4 VPN Access basato su AD Groups

Script dinamico per assegnare permessi:

```bash
#!/bin/bash
# /etc/openvpn/scripts/group-auth.sh

USERNAME="$1"
PASSWORD="$2"

# Query AD per group membership
ldapsearch -x -H ldap://dc.company.local \
    -D "cn=vpnauth,ou=Service Accounts,dc=company,dc=local" \
    -w "SecurePassword" \
    -b "dc=company,dc=local" \
    "(sAMAccountName=$USERNAME)" memberOf | grep -q "CN=VPN-FullAccess"

if [ $? -eq 0 ]; then
    # Full access
    echo "push route 192.168.0.0 255.255.0.0"
    exit 0
fi

ldapsearch ... | grep -q "CN=VPN-LimitedAccess"
if [ $? -eq 0 ]; then
    # Limited access
    echo "push route 192.168.100.0 255.255.255.0"
    exit 0
fi

# No valid group
exit 1
```

## 10.6 VPN e DMZ

### 10.6.1 Architettura a tre zone

```
Internet
   |
Firewall (perimetrale)
   |
+--+---+----------+
|  DMZ            | Internal LAN
|                 |
| VPN Gateway     | File Server
| Web Server      | Database
| Mail Relay      | AD Domain Controller
|                 |
+-----------------+ Firewall (interno)
```

**Zone di sicurezza**:
- **Internet** (Untrusted) → DMZ: Limitate porte pubbliche
- **DMZ** → **Internal**: Autenticato VPN traffic only
- **Internal** → **DMZ**: Permitted per management
- **Internal** → **Internet**: Controllato da proxy/firewall

**Regole firewall perimetrale**:

```bash
# Internet → DMZ (VPN)
iptables -A FORWARD -i eth0 -o eth1 -d 10.10.10.10 -p udp --dport 1194 -j ACCEPT

# Internet → DMZ (Web server)
iptables -A FORWARD -i eth0 -o eth1 -d 10.10.10.20 -p tcp --dport 443 -j ACCEPT

# DMZ → Internet (established only)
iptables -A FORWARD -i eth1 -o eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT

# DMZ → Internal (DENY - must go through internal firewall)
iptables -A FORWARD -i eth1 -o eth2 -j DROP
```

**Regole firewall interno**:

```bash
# VPN authenticated traffic → Internal
iptables -A FORWARD -i tun0 -o eth0 -j ACCEPT

# Internal → VPN clients (return traffic)
iptables -A FORWARD -i eth0 -o tun0 -m state --state ESTABLISHED,RELATED -j ACCEPT

# DMZ management from specific admin subnet
iptables -A FORWARD -s 192.168.99.0/24 -d 10.10.10.0/24 -p tcp --dport 22 -j ACCEPT

# Log tutto il resto
iptables -A FORWARD -j LOG --log-prefix "FW-INTERNAL-DROP: "
iptables -A FORWARD -j DROP
```

### 10.6.2 VPN Gateway Hardening

Best practices per VPN gateway in DMZ:

```bash
# Disable unnecessary services
systemctl disable bluetooth
systemctl disable cups
systemctl stop avahi-daemon

# Kernel hardening
cat >> /etc/sysctl.conf <<EOF
# IP forwarding (needed for VPN)
net.ipv4.ip_forward = 1

# Disable ICMP redirects
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0

# Enable SYN cookies
net.ipv4.tcp_syncookies = 1

# Ignore ICMP ping
net.ipv4.icmp_echo_ignore_all = 1

# Log martians
net.ipv4.conf.all.log_martians = 1

# Disable source routing
net.ipv4.conf.all.accept_source_route = 0
EOF

sysctl -p

# Fail2ban per VPN brute force
apt-get install fail2ban

cat > /etc/fail2ban/jail.d/openvpn.conf <<EOF
[openvpn]
enabled = true
port = 1194
protocol = udp
filter = openvpn
logpath = /var/log/openvpn/openvpn.log
maxretry = 3
bantime = 3600
EOF

# SELinux/AppArmor policies
# Limita OpenVPN a solo file necessari
```

## Esercizi

1. **NAT-T Testing**: Configura IPsec con NAT-T e verifica con tcpdump che traffico sia incapsulato in UDP 4500

2. **OSPF su VPN**: Implementa routing dinamico OSPF tra 3 site via OpenVPN

3. **AD Integration**: Configura autenticazione OpenVPN contro Active Directory usando LDAP

4. **DMZ Deployment**: Implementa architettura a 3 zone con VPN gateway in DMZ e firewall interno

5. **VLAN per reparto**: Assegna client VPN a diverse VLAN basandosi su AD group membership

## Riepilogo

- **NAT-T** risolve problemi IPsec con NAT usando incapsulamento UDP
- **Firewall** devono permettere porte specifiche per ogni protocollo VPN
- **Routing dinamico** (OSPF/BGP) fornisce failover automatico e scalabilità
- **VLAN** permettono segmentazione logica di utenti VPN
- **Active Directory** integrazione fornisce autenticazione centralizzata
- **DMZ** posizionamento migliora sicurezza isolando VPN gateway

---

**Precedente**: [09. Applicazioni Pratiche](09.Applicazioni_Pratiche.md)  
**Successivo**: [11. VPN Cloud e Servizi Commerciali](11.VPN_Cloud_e_Servizi_Commerciali.md)  
**Torna a**: [README](README.md)

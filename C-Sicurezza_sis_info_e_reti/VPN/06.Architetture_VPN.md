# 6. Architetture VPN

Le architetture VPN definiscono come i componenti VPN sono organizzati e interconnessi per fornire connettività sicura. La scelta dell'architettura giusta dipende da requisiti di scalabilità, ridondanza, performance e sicurezza.

## 6.1 VPN Gateway

Un **VPN Gateway** è il punto di ingresso/uscita del tunnel VPN, responsabile di terminare le connessioni VPN e instradare il traffico verso la rete interna.

### Componenti VPN Gateway

```
Internet ←→ [Firewall] ←→ [VPN Gateway] ←→ [Internal Network]
                              │
                              ├─ Authentication
                              ├─ Encryption/Decryption
                              ├─ Routing
                              └─ Policy Enforcement
```

### Tipologie di Gateway

#### 1. Software Gateway

Gateway implementato su server general-purpose.

**Vantaggi:**
- ✅ Flessibilità e personalizzazione
- ✅ Costo hardware ridotto
- ✅ Facile aggiornamento software
- ✅ Scalabilità verticale (più CPU/RAM)

**Svantaggi:**
- ❌ Performance limitate da CPU
- ❌ No hardware acceleration (senza AES-NI)
- ❌ Maggiore superficie di attacco

**Esempio: Linux con strongSwan/OpenVPN**
```
Hardware: Server standard con Linux
Software: strongSwan, OpenVPN, WireGuard
CPU: Multi-core con AES-NI
RAM: 8GB+ per ~1000 concurrent users
Network: 10Gbps NIC
```

#### 2. Hardware Appliance

Dispositivo dedicato ottimizzato per VPN.

**Vantaggi:**
- ✅ Performance elevate
- ✅ Hardware crypto accelerator
- ✅ Throughput garantito
- ✅ Management interface dedicata
- ✅ Supporto vendor

**Svantaggi:**
- ❌ Costo elevato
- ❌ Vendor lock-in
- ❌ Scalabilità limitata (upgrade hardware)

**Vendor comuni:**
- Cisco ASA, Cisco ISR
- Fortinet FortiGate
- Palo Alto Networks
- Juniper SRX
- pfSense/OPNsense appliance

**Specifiche tipiche:**
```
Cisco ASA 5525-X:
- IPsec VPN: 1 Gbps
- SSL VPN: 600 Mbps
- Concurrent users: 2000
- Site-to-Site: 1000
- Throughput firewall: 2 Gbps
- Costo: ~$5000-8000
```

#### 3. Virtual Appliance

Appliance virtualizzata su hypervisor.

**Architettura:**
```
┌───────────────────────────────────────┐
│         Hypervisor (VMware/KVM)       │
│  ┌──────────┐  ┌──────────┐           │
│  │ VPN VM 1 │  │ VPN VM 2 │  ...      │
│  └──────────┘  └──────────┘           │
└───────────────────────────────────────┘
        Physical Server
```

**Vantaggi:**
- ✅ Deployment rapido
- ✅ Backup e snapshot facili
- ✅ Scalabilità orizzontale (più VM)
- ✅ Migrazione live possibile
- ✅ Consolidamento hardware

**Svantaggi:**
- ❌ Overhead virtualizzazione (~10-20%)
- ❌ Limitazioni hardware passthrough
- ❌ Licensing (alcuni vendor)

**Prodotti:**
- Cisco CSR 1000V
- Fortinet FortiGate-VM
- pfSense virtual
- VyOS

#### 4. Cloud Gateway

VPN gateway fornito come servizio cloud.

**Provider:**
- AWS VPN Gateway
- Azure VPN Gateway
- Google Cloud VPN
- Oracle Cloud VPN

**Architettura AWS:**
```
On-Premise Network
       │
       │ IPsec Tunnel
       ↓
AWS Virtual Private Gateway
       │
       ↓
    AWS VPC
   ┌──┴───┐
   EC2  RDS  Lambda
```

**Vantaggi:**
- ✅ Managed service (no manutenzione)
- ✅ Alta disponibilità integrata
- ✅ Scalabilità automatica
- ✅ Integrazione nativa cloud
- ✅ Pay-per-use

**Svantaggi:**
- ❌ Vendor lock-in cloud
- ❌ Costi variabili (traffic-based)
- ❌ Meno controllo granulare

### Dimensionamento Gateway

**Formula approssimativa:**
```
Concurrent Users = (Bandwidth_Mbps × 1000) / (Average_Traffic_per_User_Kbps)

Esempio:
Gateway con 1 Gbps throughput
User medio: 500 Kbps
Concurrent users = (1000 × 1000) / 500 = 2000 users
```

**Considerare:**
- CPU cores per encryption (1 core ≈ 200-500 Mbps AES-256)
- RAM (≈ 10-50 MB per concurrent user)
- Sessioni simultanee supportate dal sistema operativo
- Overhead protocollo (~10-15% per IPsec, ~15-25% per SSL/TLS)

### Placement Gateway

**DMZ Placement (raccomandato):**
```
Internet ←→ Firewall Esterno ←→ DMZ (VPN Gateway) ←→ Firewall Interno ←→ LAN
```

**Vantaggi:**
- Isolamento VPN da LAN interna
- Doppia protezione firewall
- Logging e monitoraggio centralizzato

**Inline Placement:**
```
Internet ←→ VPN Gateway ←→ LAN
```

**Vantaggi:**
- Più semplice
- Meno latenza

**Svantaggi:**
- VPN gateway è single point of failure
- Compromissione diretta alla LAN

## 6.2 VPN Concentrator

Un **VPN Concentrator** è un dispositivo specializzato per gestire un grande numero di connessioni VPN simultanee.

### Caratteristiche

**Vs. standard gateway:**
- Ottimizzato per alto numero di connessioni (10.000+)
- Hardware crypto accelerators multipli
- Load balancing integrato
- Session persistence
- Clustering support

### Architettura Concentrator

```
┌──────────────────────────────────────────┐
│       VPN Concentrator Cluster           │
│  ┌────────────┐      ┌────────────┐      │
│  │ VPN Node 1 │      │ VPN Node 2 │      │
│  │ 5000 users │      │ 5000 users │      │
│  └─────┬──────┘      └─────┬──────┘      │
│        └──────┬──────┬──────┘            │
│               │  HA  │                   │
│          ┌────▼──────▼───┐               │
│          │  Shared State │               │
│          │   Database    │               │
│          └───────────────┘               │
└──────────────────────────────────────────┘
             │
             ↓
       Internal Network
```

### Session Management

**Sticky Sessions:**
```
User_IP_Hash % Num_Nodes = Target_Node

Example:
User 192.168.1.100
Hash(192.168.1.100) % 3 = 1
→ Always directed to Node 1
```

**Stateful Failover:**
```
Primary Node → [Session replication] → Backup Node

On failure:
Client reconnects → Backup becomes Primary
                 → Session state preserved
```

### Use Cases

1. **Large enterprises** (10.000+ remote workers)
2. **Service Providers** (VPN as a service)
3. **Educational institutions** (thousands of students)
4. **Government** (secure remote access at scale)

## 6.3 Architetture ridondanti

La **ridondanza** garantisce alta disponibilità eliminando single points of failure.

### Active/Passive (Hot Standby)

```
           Load Balancer (VIP: 203.0.113.10)
                    │
        ┌───────────┴────────────┐
        │                        │
   ┌────▼─────┐             ┌────▼─────┐
   │ Primary  │   Heartbeat │ Secondary│
   │ VPN GW   │◄───────────►│ VPN GW   │
   │ (Active) │     VRRP    │(Standby) │
   └────┬─────┘             └────┬─────┘
        │                        │
        └───────────┬────────────┘
                    │
              Internal LAN
```

**Caratteristiche:**
- Un nodo attivo, uno in standby
- Failover automatico (~1-5 secondi)
- Heartbeat monitoring (VRRP, keepalived)
- Client reconnection richiesta

**Configurazione keepalived (Linux):**
```bash
# Primary node
vrrp_instance VPN_HA {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 150           # Higher priority = Primary
    advert_int 1
    
    authentication {
        auth_type PASS
        auth_pass SecretPass123
    }
    
    virtual_ipaddress {
        203.0.113.10/24    # VIP
    }
    
    # Health check
    track_script {
        chk_openvpn
    }
}

# Script health check
vrrp_script chk_openvpn {
    script "/usr/local/bin/check_vpn.sh"
    interval 2
    weight -20   # Reduce priority if fails
}
```

```bash
#!/bin/bash
# check_vpn.sh
if ! pgrep -x openvpn > /dev/null; then
    exit 1
fi
if ! ss -tuln | grep -q ':1194'; then
    exit 1
fi
exit 0
```

**Secondary node:** identica configurazione con `priority 100`

### Active/Active (Load Balanced)

```
            DNS Round Robin / Load Balancer
        vpn1.company.com      vpn2.company.com
        203.0.113.10          203.0.113.11
                │                    │
        ┌───────┴────────┬───────────┴───────┐
        │                │                   │
   ┌────▼─────┐     ┌────▼─────┐        ┌────▼─────┐
   │ VPN GW 1 │     │ VPN GW 2 │        │ VPN GW 3 │
   │  Active  │     │  Active  │        │  Active  │
   └────┬─────┘     └────┬─────┘        └────┬─────┘
        │                │                   │
        └────────────────┴───────────────────┘
                         │
                   Internal LAN
```

**Caratteristiche:**
- Tutti i nodi attivi simultaneamente
- Traffic distribution (DNS round-robin, L4/L7 LB)
- Scalabilità lineare
- No session persistence tra nodi

**DNS Round Robin:**
```
vpn.company.com    IN  A  203.0.113.10
vpn.company.com    IN  A  203.0.113.11
vpn.company.com    IN  A  203.0.113.12
```

**Layer 4 Load Balancer (HAProxy):**
```
frontend vpn_frontend
    bind *:1194
    mode tcp
    default_backend vpn_backend

backend vpn_backend
    mode tcp
    balance roundrobin
    option tcp-check
    
    server vpn1 192.168.1.10:1194 check
    server vpn2 192.168.1.11:1194 check
    server vpn3 192.168.1.12:1194 check
```

### Geographic Redundancy

```
┌─────────────────┐              ┌─────────────────┐
│   Data Center   │              │   Data Center   │
│     Europe      │              │      US         │
│                 │              │                 │
│  VPN Gateway    │              │  VPN Gateway    │
│  10.0.1.0/24    │              │  10.0.2.0/24    │
└────────┬────────┘              └────────┬────────┘
         │                                │
         └────────────┬───────────────────┘
                      │
              ┌───────▼────────┐
              │  Global        │
              │  DNS / GeoDNS  │
              └────────────────┘
                      │
         ┌────────────┴────────────┐
         │                         │
   European Users            American Users
         │                         │
         ↓                         ↓
   Europe DC (low latency)    US DC (low latency)
```

**GeoDNS configuration (Route 53):**
```
Geolocation routing policy:
- Europe → vpn-eu.company.com (52.51.100.10)
- US → vpn-us.company.com (54.225.100.20)
- Asia → vpn-asia.company.com (13.250.100.30)
- Default → vpn-eu.company.com
```

**Benefits:**
- ✅ Disaster recovery geografico
- ✅ Latenza ridotta (users connect to nearest)
- ✅ Compliance (data sovereignty)
- ✅ Scalabilità globale

### N+1 Redundancy

```
Required Capacity: N nodes
Deployed: N+1 nodes

Example:
Traffic peak: 4000 concurrent users
Per-node capacity: 1000 users
Required nodes: 4
Deployed: 5 (4+1)

→ Any single node failure: capacity remains adequate
```

**Sizing:**
```
N = ceil(Peak_Users / Per_Node_Capacity)
Total_Nodes = N + Redundancy_Factor

For 99.9% availability: Redundancy = 1
For 99.99% availability: Redundancy = 2
```

## 6.4 Split Tunneling vs Full Tunneling

### Full Tunneling

**Tutto il traffico** passa attraverso il tunnel VPN.

```
┌──────────┐                           ┌─────────────┐
│  Client  │───────VPN Tunnel──────────│ VPN Gateway │
│          │                           │             │
│ Internet │                           │   Internet  │
│  Req     │─────────────────────────→ │     Req     │
└──────────┘                           └──────┬──────┘
                                              │
                                              ↓
                                         Internet
```

**Vantaggi:**
- ✅ Massima sicurezza (tutto crittografato)
- ✅ Traffic inspection centralizzata
- ✅ Policy enforcement consistente
- ✅ Data Loss Prevention (DLP)
- ✅ Compliance semplificato

**Svantaggi:**
- ❌ Latenza maggiore per Internet browsing
- ❌ Bandwidth gateway sotto stress
- ❌ Performance peggiori per streaming/download
- ❌ Costo bandwidth maggiore

**Configurazione:**
```bash
# OpenVPN - redirect gateway
push "redirect-gateway def1"

# IPsec strongSwan
leftsubnet=0.0.0.0/0   # Route all traffic

# Cisco
# Split-tunnel policy: tunnelall
```

### Split Tunneling

**Solo traffico destinato alla rete aziendale** passa per VPN.

```
┌──────────┐                           ┌─────────────┐
│  Client  │                           │ VPN Gateway │
│          │                           │             │
│ Corporate│───────VPN Tunnel──────────│  Corporate  │
│  Traffic │                           │   Network   │
│          │                           └─────────────┘
│          │
│ Internet │
│  Traffic │────────────Direct───────→  Internet
└──────────┘
```

**Vantaggi:**
- ✅ Performance migliori per Internet
- ✅ Latenza ridotta
- ✅ Meno carico su gateway VPN
- ✅ Bandwidth preservata

**Svantaggi:**
- ❌ Rischio sicurezza (client può essere compromesso)
- ❌ No traffic inspection per Internet traffic
- ❌ Difficile policy enforcement
- ❌ Compliance issues possibili

**Configurazione:**
```bash
# OpenVPN - push solo route specifiche
push "route 192.168.1.0 255.255.255.0"
push "route 10.0.0.0 255.0.0.0"
# NO redirect-gateway

# IPsec strongSwan
leftsubnet=192.168.1.0/24,10.0.0.0/8

# Cisco ACL
access-list 101 permit ip 10.1.0.0 0.0.255.255 192.168.1.0 0.0.0.255
crypto map mymap 10 match address 101
```

### Split Tunneling Intelligente

Decisione dinamica basata su destination.

**Application-aware split tunneling:**
```
Rules:
- Microsoft 365: Direct Internet
- Internal ERP: VPN Tunnel
- Salesforce: Direct Internet
- File Server: VPN Tunnel
- AWS S3: Direct Internet
- Database: VPN Tunnel
```

**Implementazione (DNS-based):**
```bash
# OpenVPN client-side script
route add 192.168.0.0 mask 255.255.0.0 10.8.0.1  # Corporate via VPN
route add 52.0.0.0 mask 255.0.0.0 192.168.1.1     # AWS direct
route add 40.0.0.0 mask 255.0.0.0 192.168.1.1     # Azure direct
```

**Prodotti enterprise:**
- Zscaler Private Access
- Cisco AnyConnect with Dynamic Split Tunneling
- Palo Alto GlobalProtect with App-based routing

### Decisione Split vs Full

**Usare Full Tunneling quando:**
- Compliance richiede DLP
- Zero-trust architecture
- Dati sensibili
- Industria regolamentata (healthcare, finance)

**Usare Split Tunneling quando:**
- Performance critiche
- Bandwidth gateway limitata
- Costi bandwidth elevati
- Application cloud-native (Office 365, G Suite)

## 6.5 VPN in ambiente cloud

### Hybrid Cloud VPN

Connettere datacenter on-premise con cloud provider.

```
┌────────────────────────────┐
│   On-Premise Datacenter    │
│                            │
│  ┌──────────────────────┐  │
│  │  Corporate Network   │  │
│  │  192.168.0.0/16      │  │
│  └──────────┬───────────┘  │
│             │              │
│    ┌────────▼────────┐     │
│    │  VPN Gateway    │     │
│    │  (strongSwan)   │     │
│    └────────┬────────┘     │
└─────────────┼──────────────┘
              │
              │ IPsec Tunnel
              │ (Internet)
              │
┌─────────────▼──────────────┐
│      AWS VPC               │
│      10.0.0.0/16           │
│                            │
│  ┌──────────────────────┐  │
│  │ Virtual Private GW   │  │
│  │ (Managed by AWS)     │  │
│  └──────────┬───────────┘  │
│             │              │
│  ┌──────────▼───────────┐  │
│  │  EC2 Instances       │  │
│  │  RDS Database        │  │
│  │  S3 (via endpoint)   │  │
│  └──────────────────────┘  │
└────────────────────────────┘
```

**AWS VPN Configuration:**
```hcl
# Terraform
resource "aws_vpn_gateway" "main" {
  vpc_id = aws_vpc.main.id
  tags = {
    Name = "main-vpn-gateway"
  }
}

resource "aws_customer_gateway" "main" {
  bgp_asn    = 65000
  ip_address = "203.0.113.10"  # On-premise public IP
  type       = "ipsec.1"
}

resource "aws_vpn_connection" "main" {
  vpn_gateway_id      = aws_vpn_gateway.main.id
  customer_gateway_id = aws_customer_gateway.main.id
  type                = "ipsec.1"
  static_routes_only  = true
}

resource "aws_vpn_connection_route" "office" {
  destination_cidr_block = "192.168.0.0/16"
  vpn_connection_id      = aws_vpn_connection.main.id
}
```

**On-premise configuration (strongSwan):**
```bash
conn aws-vpn-tunnel1
    auto=start
    left=%defaultroute
    leftid=203.0.113.10
    leftsubnet=192.168.0.0/16
    right=52.50.100.10         # AWS VPN endpoint
    rightsubnet=10.0.0.0/16
    ike=aes128-sha1-modp1024!
    esp=aes128-sha1!
    keyexchange=ikev1
    authby=secret
    type=tunnel
```

### Multi-Cloud VPN

Connettere multiple cloud providers.

```
        ┌───────────────┐
        │  On-Premise   │
        │   Datacenter  │
        └───────┬───────┘
                │
        ┌───────┴───────┐
        │               │
        │               │
   ┌────▼─────┐   ┌────▼──────┐
   │   AWS    │   │   Azure   │
   │   VPN    │   │    VPN    │
   └────┬─────┘   └────┬──────┘
        │               │
        └───────┬───────┘
                │
          ┌─────▼──────┐
          │   Google   │
          │  Cloud VPN │
          └────────────┘

Each cloud accessible from on-premise and between each other
```

**Mesh VPN architecture:**
- Ogni cloud ha VPN gateway
- Tunnel tra ogni coppia di cloud
- Routing dinamico (BGP)

### Cloud-Native VPN

**AWS Client VPN:**
```
Remote Users
    │
    ↓ (OpenVPN protocol)
AWS Client VPN Endpoint
    │
    ↓
AWS VPC (private subnets)
```

**Configuration:**
```bash
aws ec2 create-client-vpn-endpoint \
  --client-cidr-block "10.250.0.0/16" \
  --server-certificate-arn "arn:aws:acm:..." \
  --authentication-options Type=certificate-authentication,MutualAuthentication={ClientRootCertificateChainArn=arn:aws:acm:...} \
  --connection-log-options Enabled=true,CloudwatchLogGroup=vpn-logs
```

**Azure Point-to-Site VPN:**
```
Address Pool: 172.16.0.0/24
Tunnel Type: OpenVPN
Authentication: Azure AD, Certificate
Gateway SKU: VpnGw2
```

### SD-WAN con VPN

Software-Defined WAN integra VPN per connectivity.

```
┌──────────────┐         ┌──────────────┐
│ Branch 1     │         │ Branch 2     │
│ SD-WAN Edge  │         │ SD-WAN Edge  │
└──────┬───────┘         └──────┬───────┘
       │                        │
       │  ┌──────────────────┐  │
       └──┤  SD-WAN Overlay  ├──┘
          │  (VPN Mesh)      │
          └────────┬─────────┘
                   │
          ┌────────▼─────────┐
          │  SD-WAN          │
          │  Controller      │
          │  (Orchestration) │
          └──────────────────┘
```

**Benefits:**
- Automatic failover tra link multipli
- Application-aware routing
- WAN optimization
- Centralized management

**Vendor:**
- VMware SD-WAN (VeloCloud)
- Cisco SD-WAN (Viptela)
- Fortinet SD-WAN
- Silver Peak

---

**Capitolo precedente**: [05. Sicurezza nelle VPN](05.Sicurezza_nelle_VPN.md)  
**Prossimo capitolo**: [07. Configurazione e Implementazione](07.Configurazione_e_Implementazione.md)

# ========================================
# APACHE VIRTUAL HOST CONFIGURATION
# Prova A038_ORD24
# Web Server: 10.50.100.10 (DMZ)
# File: /etc/apache2/sites-available/azienda.conf
# Data: 30 Gennaio 2026
# ========================================

# ========================================
# VIRTUAL HOST HTTP (Porta 80)
# Redirect automatico a HTTPS
# ========================================

<VirtualHost *:80>
    ServerName www.azienda.local
    ServerAlias azienda.local web.azienda.local
    ServerAdmin admin@azienda.local
    
    # Document Root
    DocumentRoot /var/www/azienda/public_html
    
    # Log files
    ErrorLog ${APACHE_LOG_DIR}/azienda-error.log
    CustomLog ${APACHE_LOG_DIR}/azienda-access.log combined
    
    # Redirect tutto il traffico HTTP a HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

# ========================================
# VIRTUAL HOST HTTPS (Porta 443)
# Configurazione sicura con SSL/TLS
# ========================================

<VirtualHost *:443>
    ServerName www.azienda.local
    ServerAlias azienda.local web.azienda.local portal.azienda.local
    ServerAdmin admin@azienda.local
    
    # Document Root
    DocumentRoot /var/www/azienda/public_html
    
    # Directory Options
    <Directory /var/www/azienda/public_html>
        Options -Indexes +FollowSymLinks -ExecCGI
        AllowOverride All
        Require all granted
        
        # Protezione htaccess
        <Files ".ht*">
            Require all denied
        </Files>
    </Directory>
    
    # ========================================
    # CONFIGURAZIONE SSL/TLS
    # ========================================
    
    SSLEngine on
    
    # Certificati SSL
    SSLCertificateFile      /etc/ssl/certs/azienda.local.crt
    SSLCertificateKeyFile   /etc/ssl/private/azienda.local.key
    SSLCertificateChainFile /etc/ssl/certs/azienda-chain.crt
    
    # Protocolli SSL/TLS sicuri (no SSLv2, SSLv3, TLSv1.0, TLSv1.1)
    SSLProtocol             all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    
    # Cipher Suite sicuri (raccomandazione Mozilla Intermediate)
    SSLCipherSuite          ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder     off
    
    # OCSP Stapling (performance e privacy)
    SSLUseStapling          on
    SSLStaplingCache        "shmcb:logs/stapling-cache(150000)"
    
    # ========================================
    # SECURITY HEADERS
    # ========================================
    
    # HTTP Strict Transport Security (HSTS)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Previeni clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Previeni MIME sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"
    
    # Content Security Policy
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'"
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permissions Policy
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Nascondi versione server
    ServerTokens Prod
    ServerSignature Off
    Header unset X-Powered-By
    
    # ========================================
    # LOGGING
    # ========================================
    
    ErrorLog ${APACHE_LOG_DIR}/azienda-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/azienda-ssl-access.log combined
    
    # Log level per debug (cambiare a 'warn' in produzione)
    LogLevel warn ssl:warn
    
    # ========================================
    # PHP CONFIGURATION (se utilizzato)
    # ========================================
    
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php/php8.1-fpm.sock|fcgi://localhost"
    </FilesMatch>
    
    # Limiti PHP
    php_value upload_max_filesize 20M
    php_value post_max_size 25M
    php_value max_execution_time 300
    php_value max_input_time 300
    php_value memory_limit 256M
    
    # ========================================
    # REWRITE RULES
    # ========================================
    
    <IfModule mod_rewrite.c>
        RewriteEngine On
        
        # Forza trailing slash per directory
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteCond %{REQUEST_URI} !/$
        RewriteRule ^(.*)$ $1/ [R=301,L]
        
        # Blocca accesso a file sensibili
        RewriteRule "^\.git" - [F,L]
        RewriteRule "^\.env" - [F,L]
        RewriteRule "^composer\.(json|lock)" - [F,L]
        RewriteRule "^package(-lock)?\.json" - [F,L]
    </IfModule>
    
    # ========================================
    # COMPRESSIONE
    # ========================================
    
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE application/javascript application/json
        AddOutputFilterByType DEFLATE application/xml application/xhtml+xml
        AddOutputFilterByType DEFLATE image/svg+xml
    </IfModule>
    
    # ========================================
    # CACHE CONTROL
    # ========================================
    
    <IfModule mod_expires.c>
        ExpiresActive On
        
        # Immagini - cache 1 anno
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType image/webp "access plus 1 year"
        
        # CSS e JavaScript - cache 1 mese
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"
        
        # Fonts - cache 1 anno
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/ttf "access plus 1 year"
        
        # HTML - cache 1 ora
        ExpiresByType text/html "access plus 1 hour"
        
        # Default
        ExpiresDefault "access plus 1 week"
    </IfModule>
    
    # ========================================
    # RATE LIMITING (mod_evasive)
    # ========================================
    
    <IfModule mod_evasive20.c>
        DOSHashTableSize    3097
        DOSPageCount        10
        DOSSiteCount        100
        DOSPageInterval     1
        DOSSiteInterval     1
        DOSBlockingPeriod   60
        DOSEmailNotify      admin@azienda.local
    </IfModule>
    
</VirtualHost>

# ========================================
# ABILITAZIONE MODULI NECESSARI
# ========================================

# sudo a2enmod ssl
# sudo a2enmod rewrite
# sudo a2enmod headers
# sudo a2enmod deflate
# sudo a2enmod expires
# sudo a2enmod proxy_fcgi
# sudo a2enmod http2

# ========================================
# ABILITAZIONE SITO
# ========================================

# sudo a2ensite azienda.conf
# sudo a2dissite 000-default.conf
# sudo apache2ctl configtest
# sudo systemctl reload apache2

# ========================================
# GENERAZIONE CERTIFICATO SSL SELF-SIGNED
# (Per test - usare Let's Encrypt in produzione)
# ========================================

# sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#     -keyout /etc/ssl/private/azienda.local.key \
#     -out /etc/ssl/certs/azienda.local.crt \
#     -subj "/C=IT/ST=Lazio/L=Roma/O=Azienda/CN=www.azienda.local"

# ========================================
# TEST
# ========================================

# curl -I http://10.50.100.10
# curl -k -I https://10.50.100.10
# openssl s_client -connect 10.50.100.10:443 -servername www.azienda.local

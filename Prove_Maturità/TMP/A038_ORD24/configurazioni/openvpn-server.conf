# ========================================
# OPENVPN SERVER CONFIGURATION
# Prova A038_ORD24
# VPN Server: 10.50.20.15
# File: /etc/openvpn/server.conf
# Data: 30 Gennaio 2026
# ========================================

# ========================================
# CONFIGURAZIONE RETE VPN
# ========================================

# Protocollo e porta
proto udp
port 1194

# Dispositivo TUN (routing IP)
dev tun

# Topologia subnet (consigliata)
topology subnet

# Rete VPN interna: 10.50.200.0/26
server 10.50.200.0 255.255.255.192

# Pool IP client: 10.50.200.10 - 10.50.200.60
ifconfig-pool-persist /var/log/openvpn/ipp.txt

# ========================================
# CERTIFICATI E CHIAVI (PKI)
# ========================================

# Certificate Authority
ca /etc/openvpn/pki/ca.crt

# Certificato server
cert /etc/openvpn/pki/issued/server.crt

# Chiave privata server
key /etc/openvpn/pki/private/server.key

# Diffie-Hellman parameters
dh /etc/openvpn/pki/dh.pem

# TLS auth key (extra security layer)
tls-auth /etc/openvpn/pki/ta.key 0

# ========================================
# CRITTOGRAFIA
# ========================================

# Cipher per data channel
cipher AES-256-CBC

# Auth digest
auth SHA256

# Data channel cipher negotiation
ncp-ciphers AES-256-GCM:AES-128-GCM:AES-256-CBC

# TLS cipher
tls-cipher TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384:TLS-DHE-RSA-WITH-AES-256-GCM-SHA384

# Versione minima TLS
tls-version-min 1.2

# ========================================
# ROUTING - PUSH ROUTE AI CLIENT
# ========================================

# Push route verso reti aziendali
push "route 10.50.10.0 255.255.255.0"   # LAN1 Utenti
push "route 10.50.20.0 255.255.255.0"   # LAN2 Server
push "route 10.50.30.0 255.255.255.0"   # LAN3 Admin

# Push DNS server
push "dhcp-option DNS 10.50.20.10"
push "dhcp-option DOMAIN azienda.local"

# Redirect gateway (tutto il traffico via VPN) - OPZIONALE
# push "redirect-gateway def1 bypass-dhcp"

# ========================================
# CLIENT CONFIGURATION
# ========================================

# Numero massimo client connessi
max-clients 50

# Client-to-client communication (opzionale)
# client-to-client

# Persistenza chiavi e TUN device
persist-key
persist-tun

# ========================================
# SICUREZZA
# ========================================

# User e group non privilegiati (dopo startup)
user nobody
group nogroup

# Verifica certificati client
remote-cert-tls client

# Verifica nome comune certificato (CN)
# verify-x509-name "client" name-prefix

# Certificate Revocation List
# crl-verify /etc/openvpn/pki/crl.pem

# ========================================
# KEEPALIVE E TIMEOUT
# ========================================

# Keepalive ping every 10s, timeout after 120s
keepalive 10 120

# ========================================
# COMPRESSIONE
# ========================================

# Compressione LZO (deprecata, usare comp-lzo no)
comp-lzo no

# Compressione moderna (LZ4)
compress lz4-v2
push "compress lz4-v2"

# ========================================
# LOGGING
# ========================================

# Verbosity level (0-11)
verb 3

# Log status ogni 60 secondi
status /var/log/openvpn/openvpn-status.log 60

# Log file
log-append /var/log/openvpn/openvpn.log

# Mute repeated messages
mute 20

# ========================================
# PERFORMANCE
# ========================================

# MTU optimization
tun-mtu 1500
mssfix 1420

# TCP/UDP buffer size
sndbuf 393216
rcvbuf 393216

# Multi-threading
management localhost 7505

# ========================================
# CLIENT SPECIFIC CONFIG (OPZIONALE)
# ========================================

# Directory per configurazioni client-specific
# client-config-dir /etc/openvpn/ccd

# Esempio file client-specific:
# File: /etc/openvpn/ccd/client1
# ifconfig-push 10.50.200.10 255.255.255.192
# push "route 10.50.100.0 255.255.255.192"

# ========================================
# CONFIGURAZIONE PKI CON EASY-RSA
# ========================================

# Installare easy-rsa:
# apt-get install easy-rsa

# Setup PKI:
# make-cadir /etc/openvpn/easy-rsa
# cd /etc/openvpn/easy-rsa
# ./easyrsa init-pki
# ./easyrsa build-ca nopass
# ./easyrsa gen-dh
# ./easyrsa build-server-full server nopass
# ./easyrsa build-client-full client1 nopass
# openvpn --genkey --secret /etc/openvpn/pki/ta.key

# Copiare file nella directory OpenVPN:
# cp pki/ca.crt pki/issued/server.crt pki/private/server.key /etc/openvpn/
# cp pki/dh.pem /etc/openvpn/

# ========================================
# IPTABLES FORWARDING
# ========================================

# Abilitare IP forwarding:
# echo 1 > /proc/sys/net/ipv4/ip_forward
# echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf

# Regole iptables per NAT:
# iptables -t nat -A POSTROUTING -s 10.50.200.0/26 -o eth0 -j MASQUERADE
# iptables -A FORWARD -i tun0 -j ACCEPT
# iptables -A FORWARD -o tun0 -j ACCEPT

# ========================================
# AVVIO SERVIZIO
# ========================================

# Avvio automatico:
# systemctl start openvpn@server
# systemctl enable openvpn@server

# Status:
# systemctl status openvpn@server

# Log real-time:
# tail -f /var/log/openvpn/openvpn.log
# journalctl -u openvpn@server -f

# Client connessi:
# cat /var/log/openvpn/openvpn-status.log

# ========================================
# CLIENT CONFIGURATION FILE (.ovpn)
# ========================================

# Esempio file client.ovpn:
# 
# client
# dev tun
# proto udp
# remote <IP_PUBBLICO_VPN> 1194
# resolv-retry infinite
# nobind
# persist-key
# persist-tun
# ca ca.crt
# cert client1.crt
# key client1.key
# tls-auth ta.key 1
# cipher AES-256-CBC
# auth SHA256
# verb 3
# comp-lzo no
# compress lz4-v2
